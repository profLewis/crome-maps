<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Global Crop Maps</title>
<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css">
<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/pmtiles@3.2.1/dist/pmtiles.js"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js"></script>
<style>
  body { margin: 0; padding: 0; }
  #map { position: absolute; top: 0; bottom: 0; width: 100%; }

  .panel {
    position: absolute;
    background: rgba(255,255,255,0.94);
    border-radius: 6px; font: 12px/1.6 system-ui, sans-serif;
    box-shadow: 0 1px 4px rgba(0,0,0,0.25); z-index: 2;
  }
  .panel-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 12px; cursor: grab; user-select: none;
    border-bottom: 1px solid #e0e0e0;
  }
  .panel-header:active { cursor: grabbing; }
  .panel-header h3 { margin: 0; font-size: 13px; flex: 1; }
  .panel-toggle {
    background: none; border: none; cursor: pointer;
    font-size: 14px; color: #666; padding: 0 0 0 8px; line-height: 1;
  }
  .panel-toggle:hover { color: #333; }
  .settings-btn {
    background: none; border: none; cursor: pointer;
    font-size: 15px; color: #666; padding: 0 0 0 4px; line-height: 1;
  }
  .settings-btn:hover { color: #333; }
  #settings-popover {
    display: none; position: absolute; top: 38px; left: 10px; z-index: 10;
    background: #fff; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    padding: 10px 14px; font: 12px/1.8 system-ui, sans-serif; min-width: 220px;
  }
  #settings-popover.open { display: block; }
  .settings-title { font-weight: bold; font-size: 12px; margin-bottom: 4px; border-bottom: 1px solid #e0e0e0; padding-bottom: 4px; }
  #settings-popover label { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 11.5px; }
  #settings-popover input[type="checkbox"] { margin: 0; }
  .panel-body { padding: 8px 12px; }
  .panel.collapsed .panel-body { display: none; }
  .panel.collapsed .panel-header { border-bottom: none; }

  #controls { top: 10px; left: 10px; min-width: 250px; }
  #controls .panel-body { max-height: 70vh; overflow-y: auto; }
  .layer-row {
    display: flex; align-items: center; gap: 5px; margin: 3px 0;
  }
  .layer-row input[type="checkbox"] { margin: 0; flex-shrink: 0; }
  .layer-row label { cursor: pointer; white-space: nowrap; font-size: 11.5px; flex: 1; }
  .layer-row select {
    font-size: 10px; padding: 1px 2px; border: 1px solid #ccc;
    border-radius: 3px; background: #fff; cursor: pointer;
  }
  .opacity-row {
    display: flex; align-items: center; gap: 6px;
    margin-top: 6px; padding-top: 6px; border-top: 1px solid #e0e0e0;
  }
  .opacity-row label { white-space: nowrap; }
  .opacity-row input[type="range"] { width: 90px; cursor: pointer; }
  .opacity-row span { min-width: 30px; text-align: right; font-size: 11px; }

  #legend-stack {
    position: absolute; bottom: 30px; left: 10px; z-index: 2;
    display: flex; flex-direction: column-reverse; gap: 6px;
    max-height: 85vh; overflow-y: auto; pointer-events: none;
  }
  .legend-card {
    pointer-events: auto;
    background: rgba(255,255,255,0.94); border-radius: 6px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.25);
    font: 12px/1.6 system-ui, sans-serif;
    max-width: 260px; overflow: hidden;
  }
  .legend-card-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 4px 8px; background: #f5f5f5; border-bottom: 1px solid #e0e0e0;
    cursor: pointer; user-select: none;
  }
  .legend-card-header h4 { margin: 0; font-size: 11px; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .legend-card-close {
    background: none; border: none; cursor: pointer; font-size: 14px;
    color: #999; padding: 0 0 0 6px; line-height: 1;
  }
  .legend-card-close:hover { color: #333; }
  .legend-card-body { padding: 6px 8px; max-height: 40vh; overflow-y: auto; }
  .legend-card.collapsed .legend-card-body { display: none; }
  .legend-card.collapsed .legend-card-header { border-bottom: none; }
  .legend-row { display: flex; align-items: center; gap: 6px; transition: opacity 0.15s; }
  .legend-row:hover { background: rgba(0,0,0,0.04); border-radius: 2px; }
  .legend-swatch { width: 14px; height: 14px; border-radius: 2px; flex-shrink: 0; }
  .legend-card-body img { max-width: 230px; display: block; }
  .zoom-hint { font-size: 10px; color: #e67e00; display: none; padding: 4px 0 0; }
  .zoom-hint.visible { display: block; }

  .continent-section { margin: 0; }
  .continent-header {
    display: flex; align-items: center; gap: 4px; cursor: pointer; user-select: none;
    font-weight: bold; font-size: 11px; color: #555; padding: 5px 0 3px;
    border-top: 1px solid #e0e0e0;
  }
  .continent-header:first-child { border-top: none; }
  .continent-header .arrow { font-size: 8px; color: #999; transition: transform 0.15s; }
  .continent-header.open .arrow { transform: rotate(90deg); }
  .continent-body { display: none; padding-left: 2px; }
  .continent-header.open + .continent-body { display: block; }

  #info {
    position: absolute; top: 10px; right: 50px;
    background: rgba(255,255,255,0.92); padding: 8px 12px;
    border-radius: 6px; font: 12px/1.5 system-ui, sans-serif;
    display: none; box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    max-width: 250px; z-index: 2;
  }
</style>
</head>
<body>
<div id="map"></div>

<div id="controls" class="panel">
  <div class="panel-header">
    <h3>Global Crop Maps</h3>
    <button class="settings-btn" id="settings-gear" title="Settings">&#9881;</button>
    <button class="panel-toggle" title="Collapse/expand">&#9650;</button>
  </div>
  <div class="panel-body" id="layer-list"></div>
</div>

<div id="settings-popover">
  <div class="settings-title">Settings</div>
  <label><input type="checkbox" id="setting-close-layer"> Dismiss legend also hides layer</label>
</div>

<div id="legend-stack"></div>

<div id="info"></div>

<script>
// === Settings (persisted in localStorage) ===
const SETTINGS = { closeLegendClosesLayer: true };
try {
  const saved = JSON.parse(localStorage.getItem('cropmap-settings'));
  if (saved) Object.assign(SETTINGS, saved);
} catch(e) {}
function saveSettings() { localStorage.setItem('cropmap-settings', JSON.stringify(SETTINGS)); }

// === CROME lookup tables ===
const LUCODE_LABELS = {
  "AC01":"Spring Barley","AC03":"Beet","AC04":"Borage","AC05":"Buckwheat",
  "AC06":"Canary Seed","AC07":"Carrot","AC09":"Chicory","AC10":"Daffodil",
  "AC14":"Hemp","AC15":"Lettuce","AC16":"Spring Linseed","AC17":"Maize",
  "AC18":"Millet","AC19":"Spring Oats","AC20":"Onions","AC22":"Parsley",
  "AC23":"Parsnips","AC24":"Spring Rye","AC26":"Spinach","AC27":"Strawberry",
  "AC30":"Spring Triticale","AC32":"Spring Wheat","AC34":"Spring Cabbage",
  "AC35":"Turnip","AC36":"Spring Oilseed","AC37":"Brown Mustard",
  "AC38":"Mustard","AC41":"Radish","AC44":"Potato","AC45":"Tomato",
  "AC50":"Squash","AC52":"Siam Pumpkin","AC58":"Mixed Crop 1",
  "AC59":"Mixed Crop 2","AC60":"Mixed Crop 3","AC61":"Mixed Crop 4",
  "AC62":"Mixed Crop 5","AC63":"Winter Barley","AC64":"Winter Linseed",
  "AC65":"Winter Oats","AC66":"Winter Wheat","AC67":"Winter Oilseed",
  "AC68":"Winter Rye","AC69":"Winter Triticale","AC70":"Winter Cabbage",
  "AC71":"Coriander","AC72":"Corn Gromwell","AC74":"Phacelia","AC81":"Poppy",
  "AC88":"Sunflower","AC90":"Gladioli","AC92":"Sorghum","AC94":"Sweet William",
  "AC100":"Italian Ryegrass","AC00":"Unknown/Mixed Vegetation",
  "CA02":"Cover Crop",
  "LG01":"Chickpea","LG02":"Fenugreek","LG03":"Spring Field Beans",
  "LG04":"Green Beans","LG06":"Lupins","LG07":"Spring Peas","LG08":"Soya",
  "LG09":"Cowpea","LG11":"Lucerne","LG13":"Sainfoin","LG14":"Clover",
  "LG15":"Mixed Leguminous 1","LG16":"Mixed Leguminous 2",
  "LG20":"Winter Field Beans","LG21":"Winter Peas",
  "SR01":"Short Rotation Coppice",
  "FA01":"Fallow Land","HE02":"Heathland/Bracken","HEAT":"Heather",
  "PG01":"Grass",
  "NA01":"Non-vegetated Land","WA00":"Water",
  "TC01":"Perennial Crops/Trees","NU01":"Nursery Crops",
  "WO12":"Trees/Scrubs/Hedgerows"
};
const LUCODE_COLORS = {
  "AC01":"#e6b800","AC63":"#ccaa00","AC32":"#f0d000","AC66":"#d4a017",
  "AC19":"#e8c840","AC65":"#c9a830","AC24":"#d4aa50","AC68":"#b89830",
  "AC30":"#c8a848","AC69":"#a89030","AC17":"#f5c71a","AC03":"#e07020",
  "AC07":"#ff8c00","AC44":"#cd853f","AC20":"#daa520",
  "AC36":"#ffe135","AC67":"#ffd700","AC16":"#e8d44d","AC64":"#d4c030",
  "AC04":"#d2691e","AC05":"#bc8f8f","AC06":"#deb887","AC09":"#8fbc8f",
  "AC10":"#ffff00","AC14":"#9acd32","AC15":"#90ee90","AC18":"#f4a460",
  "AC22":"#3cb371","AC23":"#ffdab9","AC26":"#2e8b57","AC27":"#ff6347",
  "AC34":"#66cdaa","AC70":"#5f9ea0","AC35":"#dda0dd","AC37":"#f0e68c",
  "AC38":"#eee8aa","AC41":"#ff7f7f","AC45":"#ff4500","AC50":"#ff8c69",
  "AC52":"#ffa07a","AC71":"#7fff00","AC72":"#6b8e23","AC74":"#8a2be2",
  "AC81":"#ff1493","AC88":"#ffa500","AC90":"#ff69b4","AC92":"#b8860b",
  "AC94":"#c71585","AC100":"#98fb98","CA02":"#bdb76b",
  "AC58":"#d2b48c","AC59":"#c4a882","AC60":"#b69a76","AC61":"#a88c6a",
  "AC62":"#9a7e5e","AC00":"#808080",
  "LG01":"#556b2f","LG02":"#6b8e23","LG03":"#228b22","LG20":"#006400",
  "LG04":"#32cd32","LG06":"#00fa9a","LG07":"#00ff7f","LG21":"#008b45",
  "LG08":"#3cb371","LG09":"#20b2aa","LG11":"#2e8b57","LG13":"#66cdaa",
  "LG14":"#00cd66","LG15":"#4f7942","LG16":"#3a6b35",
  "SR01":"#8b4513",
  "PG01":"#7cfc00","FA01":"#f5deb3","HE02":"#9370db","HEAT":"#8b668b",
  "NA01":"#a9a9a9","WA00":"#4682b4",
  "TC01":"#006400","NU01":"#228b22","WO12":"#2f4f4f"
};
const CATEGORIES = [
  { name: "Cereal / Arable", codes: ["AC66","AC63","AC32","AC01","AC19","AC65","AC24","AC68","AC30","AC69","AC17","AC67","AC36","AC64","AC16","AC03","AC07","AC44","AC20"] },
  { name: "Other Arable", codes: ["AC04","AC14","AC27","AC81","AC88","AC00"] },
  { name: "Leguminous", codes: ["LG03","LG20","LG07","LG21","LG14","LG11"] },
  { name: "Grassland", codes: ["PG01","FA01","HE02","HEAT"] },
  { name: "Trees / Woodland", codes: ["WO12","TC01","NU01","SR01"] },
  { name: "Other", codes: ["NA01","WA00","CA02"] },
];

// === EuroCrops color scheme by crop type ===
// Group ~173 crop names into color families; top categories cover 95%+ of features
const EC_COLORS = {
  // Cereals â€” yellows/golds
  'winter_common_soft_wheat': '#d4a017', 'spring_common_soft_wheat': '#e6b800',
  'winter_durum_hard_wheat': '#c9a830', 'winter_barley': '#ccaa00',
  'spring_barley': '#e8c840', 'summer_barley': '#dbb840',
  'winter_rye': '#b89830', 'spring_rye': '#c4a848', 'summer_rye': '#b09040',
  'winter_triticale': '#a89030', 'spring_triticale': '#b89840',
  'winter_oats': '#c8a848', 'spring_oats': '#d8b858', 'summer_oats': '#c0a040',
  'grain_maize_corn_popcorn': '#f5c71a', 'green_silo_maize': '#e8b800',
  'spelt': '#c0a030', 'winter_spelt': '#b09020', 'buckwheat': '#bc8f8f',
  'millet_sorghum': '#f4a460', 'rice': '#fff8dc',
  'unspecified_cereals': '#d0b050', 'unspecified_season_unspecified_cereals': '#c8a848',
  'winter_unspecified_cereals': '#c4a040', 'spring_unspecified_cereals': '#d4b050',
  'summer_unspecified_cereals': '#ccaa48', 'arable_crops': '#dab860',
  // Oilseeds â€” oranges
  'winter_rapeseed_rape': '#ffa500', 'spring_rapeseed_rape': '#ffb347',
  'rapeseed_rape': '#ff9800', 'summer_rapeseed_rape': '#ffb040',
  'sunflower': '#ffc107', 'flax_linen': '#e8d44d', 'soy_soybeans': '#cdaa20',
  'mustard': '#eee8aa', 'hemp_cannabis': '#9acd32',
  // Legumes â€” bright greens
  'beans': '#228b22', 'peas': '#00ff7f', 'lentils': '#3cb371',
  'chickpeas': '#556b2f', 'sweet_lupins': '#00fa9a', 'vetches': '#6b8e23',
  'legumes_dried_pulses_protein_crops': '#2e8b57',
  'legumes_harvested_green': '#32cd32', 'other_dry_pulses': '#4f7942',
  'clover': '#00cd66', 'alfalfa_lucerne': '#2e8b57',
  // Root crops â€” browns/tans
  'potatoes': '#cd853f', 'sugar_beet': '#deb887', 'beetroot_beets': '#e07020',
  'carrots_daucus': '#ff8c00', 'fodder_roots': '#d2691e',
  'mangelwurzel_fodder_beet': '#c87830',
  // Grass/pasture â€” greens
  'pasture_meadow_grassland_grass': '#7cfc00', 'temporary_grass': '#90ee90',
  'lolium_ryegrass': '#98fb98', 'festuca_fescue': '#8fbc8f', 'timothy': '#86c67c',
  // Vegetables â€” reds/pinks
  'fresh_vegetables': '#ff6347', 'onions': '#daa520', 'leek': '#8db600',
  'asparagus': '#87ceeb', 'spinach': '#2e8b57', 'chicory_chicories': '#8fbc8f',
  'strawberries': '#ff4040',
  // Orchards/fruits â€” purples
  'orchards_fruits': '#9370db', 'unspecified_orchards_fruits': '#8b668b',
  'apples': '#ff6b6b', 'pears': '#c5e17a', 'cherry_cherries': '#dc143c',
  'walnuts': '#8b7355', 'berries_berry_species': '#9400d3',
  'vineyards_wine_vine_rebland_grapes': '#722f72',
  // Trees/forest â€” dark greens
  'tree_wood_forest': '#2f4f4f', 'other_tree_wood_forest': '#3a5f3a',
  'afforestation_reforestation': '#355e3b', 'shrubberries_shrubs': '#4a7c59',
  'nurseries_nursery': '#228b22',
  // Flowers
  'flowers_ornamental_plants': '#ff69b4',
  // Fallow/other â€” grays
  'fallow_land_not_crop': '#d2b48c', 'not_known_and_other': '#a9a9a9',
  'unmaintained': '#c0c0c0', 'other_arable_land_crops': '#b0a898',
  'other_industrial_crops': '#a0937c', 'other_permanent_crops_plantations': '#8b7e70',
  'permanent_crops_perennial': '#7a6e62',
  'kitchen_gardens': '#90ee90', 'sod_turf': '#7ccd7c',
};
const EC_COLOR_EXPR = ['match', ['get', 'EC_hcat_n'],
  ...Object.entries(EC_COLORS).flat(), '#888888'];

const EC_CATEGORIES = [
  { name: 'Cereals', key: ['winter_common_soft_wheat','winter_barley','grain_maize_corn_popcorn','spring_barley','winter_triticale','winter_rye'] },
  { name: 'Oilseeds', key: ['winter_rapeseed_rape','sunflower','flax_linen','soy_soybeans'] },
  { name: 'Grass / Pasture', key: ['pasture_meadow_grassland_grass','temporary_grass'] },
  { name: 'Legumes', key: ['beans','peas','clover','alfalfa_lucerne'] },
  { name: 'Root Crops', key: ['potatoes','sugar_beet','beetroot_beets'] },
  { name: 'Fruits / Vines', key: ['vineyards_wine_vine_rebland_grapes','orchards_fruits','apples'] },
  { name: 'Forest / Trees', key: ['tree_wood_forest','shrubberries_shrubs'] },
  { name: 'Fallow / Other', key: ['fallow_land_not_crop','not_known_and_other'] },
];

// Europe bounding box for filtering stray features outside the continent
const EUROPE_BBOX = { type: 'Polygon', coordinates: [[[-30, 34], [50, 34], [50, 72], [-30, 72], [-30, 34]]] };

// === Crop name translation ===
// Target language for display â€” change to 'de','fr','da','nl' etc. for other languages
const DISPLAY_LANG = 'en';

// Translation dictionaries: source language â†’ { original: { en: '...', de: '...', fr: '...', ... } }
const CROP_TRANSLATIONS = {
  // Danish (Denmark)
  da: {
    'Vinterhvede': { en: 'Winter wheat', de: 'Winterweizen', fr: 'BlÃ© tendre d\'hiver' },
    'VÃ¥rhvede': { en: 'Spring wheat', de: 'Sommerweizen', fr: 'BlÃ© de printemps' },
    'Vinterbyg': { en: 'Winter barley', de: 'Wintergerste', fr: 'Orge d\'hiver' },
    'VÃ¥rbyg': { en: 'Spring barley', de: 'Sommergerste', fr: 'Orge de printemps' },
    'Vinterrug': { en: 'Winter rye', de: 'Winterroggen', fr: 'Seigle d\'hiver' },
    'Rug': { en: 'Rye', de: 'Roggen', fr: 'Seigle' },
    'Havre': { en: 'Oats', de: 'Hafer', fr: 'Avoine' },
    'Triticale': { en: 'Triticale', de: 'Triticale', fr: 'Triticale' },
    'Vinterraps': { en: 'Winter rapeseed', de: 'Winterraps', fr: 'Colza d\'hiver' },
    'VÃ¥rraps': { en: 'Spring rapeseed', de: 'Sommerraps', fr: 'Colza de printemps' },
    'Majs': { en: 'Maize', de: 'Mais', fr: 'MaÃ¯s' },
    'Silomajs': { en: 'Silage maize', de: 'Silomais', fr: 'MaÃ¯s ensilage' },
    'Kartofler': { en: 'Potatoes', de: 'Kartoffeln', fr: 'Pommes de terre' },
    'Sukkerroer': { en: 'Sugar beet', de: 'ZuckerrÃ¼ben', fr: 'Betterave sucriÃ¨re' },
    'Solsikke': { en: 'Sunflower', de: 'Sonnenblume', fr: 'Tournesol' },
    'RajgrÃ¦s': { en: 'Ryegrass', de: 'Weidelgras', fr: 'Ray-grass' },
    'KlÃ¸ver': { en: 'Clover', de: 'Klee', fr: 'TrÃ¨fle' },
    'Lucerne': { en: 'Alfalfa', de: 'Luzerne', fr: 'Luzerne' },
    'Ã†rter': { en: 'Peas', de: 'Erbsen', fr: 'Pois' },
    'HestebÃ¸nner': { en: 'Field beans', de: 'Ackerbohnen', fr: 'FÃ©veroles' },
    'GrÃ¦s': { en: 'Grass', de: 'Gras', fr: 'Herbe' },
    'Permanent grÃ¦s': { en: 'Permanent grass', de: 'DauergrÃ¼nland', fr: 'Prairie permanente' },
    'Brak': { en: 'Fallow', de: 'Brache', fr: 'JachÃ¨re' },
    'Skov': { en: 'Forest', de: 'Wald', fr: 'ForÃªt' },
    'JuletrÃ¦er': { en: 'Christmas trees', de: 'WeihnachtsbÃ¤ume', fr: 'Sapins de NoÃ«l' },
    'HÃ¸r': { en: 'Flax', de: 'Flachs', fr: 'Lin' },
    'SojabÃ¸nner': { en: 'Soybeans', de: 'Sojabohnen', fr: 'Soja' },
    'Boghvede': { en: 'Buckwheat', de: 'Buchweizen', fr: 'Sarrasin' },
    'Hamp': { en: 'Hemp', de: 'Hanf', fr: 'Chanvre' },
    'LÃ¸g': { en: 'Onions', de: 'Zwiebeln', fr: 'Oignons' },
    'GulerÃ¸dder': { en: 'Carrots', de: 'Karotten', fr: 'Carottes' },
    'JordbÃ¦r': { en: 'Strawberries', de: 'Erdbeeren', fr: 'Fraises' },
    'Ã†bler': { en: 'Apples', de: 'Ã„pfel', fr: 'Pommes' },
  },
  // German (Austria, Switzerland, Germany)
  de: {
    'SENF': { en: 'Mustard', fr: 'Moutarde', da: 'Sennep' },
    'WINTERWEIZEN': { en: 'Winter wheat', fr: 'BlÃ© tendre d\'hiver', da: 'Vinterhvede' },
    'Winterweizen': { en: 'Winter wheat', fr: 'BlÃ© tendre d\'hiver', da: 'Vinterhvede' },
    'SOMMERWEIZEN': { en: 'Spring wheat', fr: 'BlÃ© de printemps', da: 'VÃ¥rhvede' },
    'WINTERGERSTE': { en: 'Winter barley', fr: 'Orge d\'hiver', da: 'Vinterbyg' },
    'Wintergerste': { en: 'Winter barley', fr: 'Orge d\'hiver', da: 'Vinterbyg' },
    'SOMMERGERSTE': { en: 'Spring barley', fr: 'Orge de printemps', da: 'VÃ¥rbyg' },
    'WINTERROGGEN': { en: 'Winter rye', fr: 'Seigle d\'hiver', da: 'Vinterrug' },
    'WINTERRAPS': { en: 'Winter rapeseed', fr: 'Colza d\'hiver', da: 'Vinterraps' },
    'SOMMERRAPS': { en: 'Spring rapeseed', fr: 'Colza de printemps', da: 'VÃ¥rraps' },
    'MAIS': { en: 'Maize', fr: 'MaÃ¯s', da: 'Majs' },
    'Mais': { en: 'Maize', fr: 'MaÃ¯s', da: 'Majs' },
    'SILOMAIS': { en: 'Silage maize', fr: 'MaÃ¯s ensilage', da: 'Silomajs' },
    'Silomais': { en: 'Silage maize', fr: 'MaÃ¯s ensilage', da: 'Silomajs' },
    'KARTOFFELN': { en: 'Potatoes', fr: 'Pommes de terre', da: 'Kartofler' },
    'Kartoffeln': { en: 'Potatoes', fr: 'Pommes de terre', da: 'Kartofler' },
    'ZUCKERRÃœBEN': { en: 'Sugar beet', fr: 'Betterave sucriÃ¨re', da: 'Sukkerroer' },
    'ZuckerrÃ¼ben': { en: 'Sugar beet', fr: 'Betterave sucriÃ¨re', da: 'Sukkerroer' },
    'SONNENBLUMEN': { en: 'Sunflower', fr: 'Tournesol', da: 'Solsikke' },
    'TRITICALE': { en: 'Triticale', fr: 'Triticale', da: 'Triticale' },
    'Triticale': { en: 'Triticale', fr: 'Triticale', da: 'Triticale' },
    'HAFER': { en: 'Oats', fr: 'Avoine', da: 'Havre' },
    'Hafer': { en: 'Oats', fr: 'Avoine', da: 'Havre' },
    'ERBSEN': { en: 'Peas', fr: 'Pois', da: 'Ã†rter' },
    'ACKERBOHNEN': { en: 'Field beans', fr: 'FÃ©veroles', da: 'HestebÃ¸nner' },
    'SOJABOHNEN': { en: 'Soybeans', fr: 'Soja', da: 'SojabÃ¸nner' },
    'LUZERNE': { en: 'Alfalfa', fr: 'Luzerne', da: 'Lucerne' },
    'Luzerne': { en: 'Alfalfa', fr: 'Luzerne', da: 'Lucerne' },
    'KLEE': { en: 'Clover', fr: 'TrÃ¨fle', da: 'KlÃ¸ver' },
    'Klee': { en: 'Clover', fr: 'TrÃ¨fle', da: 'KlÃ¸ver' },
    'GRÃœNLAND': { en: 'Grassland', fr: 'Prairie', da: 'GrÃ¦s' },
    'GrÃ¼nland': { en: 'Grassland', fr: 'Prairie', da: 'GrÃ¦s' },
    'DAUERGRÃœNLAND': { en: 'Permanent grassland', fr: 'Prairie permanente', da: 'Permanent grÃ¦s' },
    'DauergrÃ¼nland': { en: 'Permanent grassland', fr: 'Prairie permanente', da: 'Permanent grÃ¦s' },
    'BRACHE': { en: 'Fallow', fr: 'JachÃ¨re', da: 'Brak' },
    'Brache': { en: 'Fallow', fr: 'JachÃ¨re', da: 'Brak' },
    'DINKEL': { en: 'Spelt', fr: 'Ã‰peautre', da: 'Spelt' },
    'Dinkel': { en: 'Spelt', fr: 'Ã‰peautre', da: 'Spelt' },
    'BUCHWEIZEN': { en: 'Buckwheat', fr: 'Sarrasin', da: 'Boghvede' },
    'HANF': { en: 'Hemp', fr: 'Chanvre', da: 'Hamp' },
    'FLACHS': { en: 'Flax', fr: 'Lin', da: 'HÃ¸r' },
    'AckerflÃ¤che': { en: 'Arable land', fr: 'Terre arable', da: 'Agerjord' },
    'Kunstwiese': { en: 'Temporary grassland', fr: 'Prairie temporaire', da: 'Midlertidig grÃ¦s' },
    'Reben': { en: 'Vineyards', fr: 'Vignes', da: 'Vinmarker' },
    'Obstanlagen': { en: 'Orchards', fr: 'Vergers', da: 'Frugtplantager' },
  },
  // French (France, Belgium Wallonia, Luxembourg)
  fr: {
    'BlÃ© tendre d\'hiver': { en: 'Winter soft wheat', de: 'Winterweizen', da: 'Vinterhvede' },
    'BlÃ© tendre de printemps': { en: 'Spring soft wheat', de: 'Sommerweizen', da: 'VÃ¥rhvede' },
    'BlÃ© dur d\'hiver': { en: 'Winter durum wheat', de: 'Winterhartweizen', da: 'Vinter durumhvede' },
    'Orge d\'hiver': { en: 'Winter barley', de: 'Wintergerste', da: 'Vinterbyg' },
    'Orge de printemps': { en: 'Spring barley', de: 'Sommergerste', da: 'VÃ¥rbyg' },
    'Colza d\'hiver': { en: 'Winter rapeseed', de: 'Winterraps', da: 'Vinterraps' },
    'Colza de printemps': { en: 'Spring rapeseed', de: 'Sommerraps', da: 'VÃ¥rraps' },
    'MaÃ¯s grain': { en: 'Grain maize', de: 'KÃ¶rnermais', da: 'Majskorn' },
    'MaÃ¯s ensilage': { en: 'Silage maize', de: 'Silomais', da: 'Silomajs' },
    'Tournesol': { en: 'Sunflower', de: 'Sonnenblume', da: 'Solsikke' },
    'Seigle': { en: 'Rye', de: 'Roggen', da: 'Rug' },
    'Avoine': { en: 'Oats', de: 'Hafer', da: 'Havre' },
    'Triticale': { en: 'Triticale', de: 'Triticale', da: 'Triticale' },
    'Pommes de terre': { en: 'Potatoes', de: 'Kartoffeln', da: 'Kartofler' },
    'Betterave sucriÃ¨re': { en: 'Sugar beet', de: 'ZuckerrÃ¼ben', da: 'Sukkerroer' },
    'Pois': { en: 'Peas', de: 'Erbsen', da: 'Ã†rter' },
    'FÃ©veroles': { en: 'Field beans', de: 'Ackerbohnen', da: 'HestebÃ¸nner' },
    'Soja': { en: 'Soybeans', de: 'Sojabohnen', da: 'SojabÃ¸nner' },
    'Luzerne': { en: 'Alfalfa', de: 'Luzerne', da: 'Lucerne' },
    'TrÃ¨fle': { en: 'Clover', de: 'Klee', da: 'KlÃ¸ver' },
    'Prairie permanente': { en: 'Permanent grassland', de: 'DauergrÃ¼nland', da: 'Permanent grÃ¦s' },
    'Prairie temporaire': { en: 'Temporary grassland', de: 'Kunstwiese', da: 'Midlertidig grÃ¦s' },
    'JachÃ¨re': { en: 'Fallow', de: 'Brache', da: 'Brak' },
    'Lin': { en: 'Flax', de: 'Flachs', da: 'HÃ¸r' },
    'Chanvre': { en: 'Hemp', de: 'Hanf', da: 'Hamp' },
    'Vignes': { en: 'Vineyards', de: 'Reben', da: 'Vinmarker' },
    'Vergers': { en: 'Orchards', de: 'Obstanlagen', da: 'Frugtplantager' },
    'Moutarde': { en: 'Mustard', de: 'Senf', da: 'Sennep' },
    'Ã‰peautre': { en: 'Spelt', de: 'Dinkel', da: 'Spelt' },
    'Sarrasin': { en: 'Buckwheat', de: 'Buchweizen', da: 'Boghvede' },
  },
  // Dutch (Netherlands, Belgium Flanders)
  nl: {
    'Grasland, blijvend': { en: 'Permanent grassland', de: 'DauergrÃ¼nland', fr: 'Prairie permanente' },
    'Grasland, natuurlijk': { en: 'Natural grassland', de: 'NatÃ¼rliches GrÃ¼nland', fr: 'Prairie naturelle' },
    'Grasland, tijdelijk': { en: 'Temporary grassland', de: 'Kunstwiese', fr: 'Prairie temporaire' },
    'Wintertarwe': { en: 'Winter wheat', de: 'Winterweizen', fr: 'BlÃ© tendre d\'hiver' },
    'Zomertarwe': { en: 'Spring wheat', de: 'Sommerweizen', fr: 'BlÃ© de printemps' },
    'Wintergerst': { en: 'Winter barley', de: 'Wintergerste', fr: 'Orge d\'hiver' },
    'Zomergerst': { en: 'Spring barley', de: 'Sommergerste', fr: 'Orge de printemps' },
    'SnijmaÃ¯s': { en: 'Silage maize', de: 'Silomais', fr: 'MaÃ¯s ensilage' },
    'KorrelmaÃ¯s': { en: 'Grain maize', de: 'KÃ¶rnermais', fr: 'MaÃ¯s grain' },
    'Consumptieaardappelen': { en: 'Table potatoes', de: 'Speisekartoffeln', fr: 'Pommes de terre' },
    'Pootaardappelen': { en: 'Seed potatoes', de: 'Pflanzkartoffeln', fr: 'Plants de pommes de terre' },
    'Zetmeelaardappelen': { en: 'Starch potatoes', de: 'StÃ¤rkekartoffeln', fr: 'Pommes de terre fÃ©culiÃ¨res' },
    'Suikerbieten': { en: 'Sugar beet', de: 'ZuckerrÃ¼ben', fr: 'Betterave sucriÃ¨re' },
    'Uien': { en: 'Onions', de: 'Zwiebeln', fr: 'Oignons' },
    'Winterkoolzaad': { en: 'Winter rapeseed', de: 'Winterraps', fr: 'Colza d\'hiver' },
    'Zonnebloemen': { en: 'Sunflower', de: 'Sonnenblume', fr: 'Tournesol' },
    'Vlas': { en: 'Flax', de: 'Flachs', fr: 'Lin' },
    'Hennep': { en: 'Hemp', de: 'Hanf', fr: 'Chanvre' },
    'Erwten': { en: 'Peas', de: 'Erbsen', fr: 'Pois' },
    'Bonen': { en: 'Beans', de: 'Bohnen', fr: 'Haricots' },
    'Luzerne': { en: 'Alfalfa', de: 'Luzerne', fr: 'Luzerne' },
    'Klaver': { en: 'Clover', de: 'Klee', fr: 'TrÃ¨fle' },
    'Braakland': { en: 'Fallow', de: 'Brache', fr: 'JachÃ¨re' },
    'Haver': { en: 'Oats', de: 'Hafer', fr: 'Avoine' },
    'Rogge': { en: 'Rye', de: 'Roggen', fr: 'Seigle' },
  },
  // Norwegian (Norway)
  no: {
    'Fulldyrka jord': { en: 'Fully cultivated land', de: 'Ackerland', fr: 'Terre cultivÃ©e' },
    'Overflatedyrka jord': { en: 'Surface cultivated land', de: 'OberflÃ¤chenkultur', fr: 'Culture superficielle' },
    'Innmarksbeite': { en: 'Infield pasture', de: 'Weide', fr: 'PÃ¢turage' },
    'Skog': { en: 'Forest', de: 'Wald', fr: 'ForÃªt' },
    'Myr': { en: 'Bog/peatland', de: 'Moor', fr: 'TourbiÃ¨re' },
    'Ã…pen fastmark': { en: 'Open firm ground', de: 'Offenes Festland', fr: 'Terrain ouvert' },
    'Bebygd': { en: 'Built-up area', de: 'Bebaut', fr: 'Zone bÃ¢tie' },
    'Vann': { en: 'Water', de: 'Wasser', fr: 'Eau' },
    'SnÃ¸/is': { en: 'Snow/ice', de: 'Schnee/Eis', fr: 'Neige/glace' },
    'Hav': { en: 'Sea', de: 'Meer', fr: 'Mer' },
    'Ferskvann': { en: 'Freshwater', de: 'SÃ¼ÃŸwasser', fr: 'Eau douce' },
    'Bre': { en: 'Glacier', de: 'Gletscher', fr: 'Glacier' },
    'Samferdsel': { en: 'Transport/roads', de: 'Verkehr', fr: 'Transport' },
    'Ikke kartlagt': { en: 'Not mapped', de: 'Nicht kartiert', fr: 'Non cartographiÃ©' },
    'Barskog': { en: 'Coniferous forest', de: 'Nadelwald', fr: 'ForÃªt de conifÃ¨res' },
    'Lauvskog': { en: 'Deciduous forest', de: 'Laubwald', fr: 'ForÃªt de feuillus' },
    'Blandingsskog': { en: 'Mixed forest', de: 'Mischwald', fr: 'ForÃªt mixte' },
    'Jorddekt': { en: 'Soil-covered', de: 'Erdbedeckt', fr: 'Sol couvert' },
    'Blokkmark': { en: 'Boulder field', de: 'Blockfeld', fr: 'Champ de blocs' },
    'Grunnlendt': { en: 'Shallow soil', de: 'FlachgrÃ¼ndig', fr: 'Sol peu profond' },
    'Fjell': { en: 'Mountain', de: 'Gebirge', fr: 'Montagne' },
  },
  // Finnish (Finland)
  fi: {
    'KevÃ¤tvehnÃ¤': { en: 'Spring wheat', de: 'Sommerweizen', fr: 'BlÃ© de printemps' },
    'SyysvehnÃ¤': { en: 'Winter wheat', de: 'Winterweizen', fr: 'BlÃ© d\'hiver' },
    'Ohra': { en: 'Barley', de: 'Gerste', fr: 'Orge' },
    'Kaura': { en: 'Oats', de: 'Hafer', fr: 'Avoine' },
    'Ruis': { en: 'Rye', de: 'Roggen', fr: 'Seigle' },
    'Rypsi': { en: 'Turnip rape', de: 'RÃ¼bsen', fr: 'Navette' },
    'Rapsi': { en: 'Rapeseed', de: 'Raps', fr: 'Colza' },
    'Herne': { en: 'Peas', de: 'Erbsen', fr: 'Pois' },
    'HÃ¤rkÃ¤papu': { en: 'Faba bean', de: 'Ackerbohne', fr: 'FÃ©verole' },
    'Peruna': { en: 'Potatoes', de: 'Kartoffeln', fr: 'Pommes de terre' },
    'Sokerijuurikas': { en: 'Sugar beet', de: 'ZuckerrÃ¼be', fr: 'Betterave sucriÃ¨re' },
    'Nurmi': { en: 'Grassland', de: 'GrÃ¼nland', fr: 'Prairie' },
    'Kesanto': { en: 'Fallow', de: 'Brache', fr: 'JachÃ¨re' },
    'Luonnonhoitopelto': { en: 'Nature management field', de: 'Naturpflegefeld', fr: 'Champ de gestion naturelle' },
    'MetsÃ¤': { en: 'Forest', de: 'Wald', fr: 'ForÃªt' },
  },
  // Portuguese (Portugal)
  pt: {
    'Trigo': { en: 'Wheat', de: 'Weizen', fr: 'BlÃ©' },
    'Cevada': { en: 'Barley', de: 'Gerste', fr: 'Orge' },
    'Milho': { en: 'Maize', de: 'Mais', fr: 'MaÃ¯s' },
    'Arroz': { en: 'Rice', de: 'Reis', fr: 'Riz' },
    'Aveia': { en: 'Oats', de: 'Hafer', fr: 'Avoine' },
    'Girassol': { en: 'Sunflower', de: 'Sonnenblume', fr: 'Tournesol' },
    'Batata': { en: 'Potatoes', de: 'Kartoffeln', fr: 'Pommes de terre' },
    'Pastagem': { en: 'Pasture', de: 'Weide', fr: 'PÃ¢turage' },
    'Olival': { en: 'Olive grove', de: 'Olivenhain', fr: 'Oliveraie' },
    'Vinha': { en: 'Vineyard', de: 'Weinberg', fr: 'Vignoble' },
    'Pousio': { en: 'Fallow', de: 'Brache', fr: 'JachÃ¨re' },
  },
};

// Translate a crop name from source language to display language
function translateCrop(name, sourceLang) {
  if (!name || DISPLAY_LANG === sourceLang) return name;
  const trimmed = name.trim();
  const dict = CROP_TRANSLATIONS[sourceLang];
  if (!dict) return trimmed;
  // Exact match
  if (dict[trimmed] && dict[trimmed][DISPLAY_LANG]) {
    return dict[trimmed][DISPLAY_LANG];
  }
  // Case-insensitive match
  const lower = trimmed.toLowerCase();
  for (const [key, translations] of Object.entries(dict)) {
    if (key.toLowerCase() === lower && translations[DISPLAY_LANG]) {
      return translations[DISPLAY_LANG];
    }
  }
  // Partial match â€” check if name starts with a known key
  for (const [key, translations] of Object.entries(dict)) {
    if (lower.startsWith(key.toLowerCase()) && translations[DISPLAY_LANG]) {
      return translations[DISPLAY_LANG] + trimmed.substring(key.length);
    }
  }
  return trimmed; // No translation found â€” return original
}

// === WMS URL builders ===
function wms11(base, layers, extra) {
  return base + '?service=WMS&version=1.1.1&request=GetMap'
    + '&layers=' + encodeURIComponent(layers) + '&styles=&srs=EPSG:3857'
    + '&bbox={bbox-epsg-3857}&width=256&height=256&format=image/png&transparent=true'
    + (extra || '');
}
function wms13(base, layers) {
  return base + '?service=WMS&version=1.3.0&request=GetMap'
    + '&layers=' + encodeURIComponent(layers) + '&styles=&crs=EPSG:3857'
    + '&bbox={bbox-epsg-3857}&width=256&height=256&format=image/png&transparent=true';
}

// GetFeatureInfo URL builders â€” take (baseUrl, layers, bbox4326, x, y, extra)
// bbox4326 = [minlon, minlat, maxlon, maxlat]
function gfi11(base, layers, bbox, x, y, extra) {
  // WMS 1.1.1: SRS=EPSG:4326, bbox = minlon,minlat,maxlon,maxlat (x,y order)
  return base + '?service=WMS&version=1.1.1&request=GetFeatureInfo'
    + '&layers=' + encodeURIComponent(layers) + '&query_layers=' + encodeURIComponent(layers)
    + '&styles=&srs=EPSG:4326&info_format=application/json'
    + '&bbox=' + bbox.join(',') + '&width=256&height=256&x=' + x + '&y=' + y
    + (extra || '');
}
function gfi13(base, layers, bbox, i, j, extra) {
  // WMS 1.3.0: CRS=EPSG:4326, bbox = minlat,minlon,maxlat,maxlon (lat,lon order)
  const bbox13 = [bbox[1], bbox[0], bbox[3], bbox[2]];
  return base + '?service=WMS&version=1.3.0&request=GetFeatureInfo'
    + '&layers=' + encodeURIComponent(layers) + '&query_layers=' + encodeURIComponent(layers)
    + '&styles=&crs=EPSG:4326&info_format=application/json'
    + '&bbox=' + bbox13.join(',') + '&width=256&height=256&i=' + i + '&j=' + j
    + (extra || '');
}

// === Layer configuration ===
// Each layer defines how to build its tile URL given a year
// pmtilesFile: function(yr) returning the pmtiles filename for self-hosted files
// tileUrl: WMS URL builder (used as fallback if PMTiles not available)
const LAYERS = [
  {
    id: 'crome', label: 'ðŸ´ó §ó ¢ó ¥ó ®ó §ó ¿ England (CROME)', type: 'vector',
    legendType: 'crome', defaultOn: true,
    years: [2020, 2021, 2022, 2023, 2024], defaultYear: 2024
  },
  {
    id: 'crome-raster', label: 'ðŸ´ó §ó ¢ó ¥ó ®ó §ó ¿ England (CROME Raster)', type: 'raster', lang: 'en',
    legendType: 'crome',
    years: [2020, 2021, 2022, 2023, 2024], defaultYear: 2020,
    pmtilesFile: (yr) => 'crome-raster' + yr + '.pmtiles',
    tileUrl: (yr) => wms11('https://environment.data.gov.uk/spatialdata/crop-map-of-england-' + yr + '/wms',
      'Crop_Map_of_England_' + yr),
    featureInfo: (yr, bbox, x, y) => gfi11(
      'https://environment.data.gov.uk/spatialdata/crop-map-of-england-' + yr + '/wms',
      'Crop_Map_of_England_' + yr, bbox, x, y),
    legendImg: (yr) => 'https://environment.data.gov.uk/spatialdata/crop-map-of-england-' + yr + '/wms?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=Crop_Map_of_England_' + yr + '&format=image/png',
    attribution: 'CROME &copy; RPA. OGL v3.0.'
  },
  {
    id: 'eurocrops', label: 'ðŸ‡ªðŸ‡º EU Field Boundaries (EuroCrops)', type: 'vector-remote',
    legendType: 'eurocrops',
    years: null, defaultYear: null, dataYear: '2018-2021',
    pmtilesUrl: 'https://data.source.coop/cholmes/eurocrops/eurocrops-all.pmtiles',
    sourceLayer: 'eurocrops',
    attribution: '&copy; <a href="https://github.com/maja601/EuroCrops">EuroCrops</a> CC-BY 4.0'
  },
  {
    id: 'germany', label: 'ðŸ‡©ðŸ‡ª Germany (DLR)', type: 'raster', lang: 'en',
    legendType: 'image',
    years: [2017,2018,2019,2020,2021,2022,2023,2024], defaultYear: 2024,
    pmtilesFile: (yr) => 'germany' + yr + '.pmtiles',
    tileUrl: (yr) => wms11('https://geoservice.dlr.de/eoc/land/wms', 'CROPTYPES_DE_P1Y',
      '&TIME=' + yr + '-01-01T00:00:00Z'),
    featureInfo: (yr, bbox, x, y) => gfi11('https://geoservice.dlr.de/eoc/land/wms',
      'CROPTYPES_DE_P1Y', bbox, x, y, '&TIME=' + yr + '-01-01T00:00:00Z'),
    legendImg: 'https://geoservice.dlr.de/eoc/land/wms?request=GetLegendGraphic&version=1.1.1&format=image/png&width=20&height=20&layer=CROPTYPES_DE_P1Y',
    attribution: '&copy; <a href="https://geoservice.dlr.de">DLR EOC</a> CC-BY 4.0'
  },
  {
    id: 'france', label: 'ðŸ‡«ðŸ‡· France (RPG)', type: 'raster', lang: 'fr',
    legendType: 'image',
    years: Array.from({length:18}, (_,i) => 2007+i), defaultYear: 2024,
    pmtilesFile: (yr) => 'france' + yr + '.pmtiles',
    tileUrl: (yr) => wms13('https://data.geopf.fr/wms-r/wms', 'LANDUSE.AGRICULTURE' + yr),
    featureInfo: (yr, bbox, i, j) => gfi13('https://data.geopf.fr/wms-r/wms',
      'LANDUSE.AGRICULTURE' + yr, bbox, i, j, '&format=image/png'),
    legendImg: (yr) => 'https://data.geopf.fr/wms-r/wms?service=WMS&version=1.3.0&request=GetLegendGraphic&layer=LANDUSE.AGRICULTURE' + yr + '&format=image/png',
    attribution: '&copy; <a href="https://geoservices.ign.fr/">IGN</a> RPG Licence Ouverte'
  },
  {
    id: 'netherlands', label: 'ðŸ‡³ðŸ‡± Netherlands (BRP)', type: 'raster', lang: 'nl',
    legendType: 'image', minZoom: 12, countryNum: 528, indicatorColor: '#FF9800',
    years: null, defaultYear: null, dataYear: '2024',
    tileUrl: () => wms11('https://service.pdok.nl/rvo/brpgewaspercelen/wms/v1_0', 'BrpGewas'),
    featureInfo: (yr, bbox, x, y) => gfi11('https://service.pdok.nl/rvo/brpgewaspercelen/wms/v1_0',
      'BrpGewas', bbox, x, y),
    legendImg: 'https://service.pdok.nl/rvo/brpgewaspercelen/wms/v1_0?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=BrpGewas&format=image/png',
    attribution: '&copy; <a href="https://www.pdok.nl/">PDOK</a>/RVO CC0'
  },
  {
    id: 'belgium-fl', label: 'ðŸ‡§ðŸ‡ª Belgium - Flanders', type: 'raster', lang: 'nl',
    legendType: 'image', minZoom: 12, countryNum: 56, indicatorColor: '#E91E63',
    years: Array.from({length:17}, (_,i) => 2008+i), defaultYear: 2024,
    tileUrl: (yr) => wms13('https://geo.api.vlaanderen.be/ALV/wms', 'LbGebrPerc' + yr),
    featureInfo: (yr, bbox, i, j) => gfi13('https://geo.api.vlaanderen.be/ALV/wms',
      'LbGebrPerc' + yr, bbox, i, j),
    legendImg: (yr) => 'https://geo.api.vlaanderen.be/ALV/wms?service=WMS&version=1.3.0&request=GetLegendGraphic&layer=LbGebrPerc' + yr + '&format=image/png',
    attribution: '&copy; Dept. Landbouw &amp; Visserij Vlaanderen'
  },
  {
    id: 'belgium-wa', label: 'ðŸ‡§ðŸ‡ª Belgium - Wallonia', type: 'raster', lang: 'fr',
    legendType: 'image', minZoom: 12, countryNum: 56, indicatorColor: '#AD1457',
    years: [2019,2020,2021,2022,2023], defaultYear: 2022,
    tileUrl: (yr) => wms13(
      'https://geoservices.wallonie.be/arcgis/services/AGRICULTURE/SIGEC_PARC_AGRI_ANON__' + yr + '/MapServer/WMSServer', '1'),
    featureInfo: (yr, bbox, i, j) => gfi13(
      'https://geoservices.wallonie.be/arcgis/services/AGRICULTURE/SIGEC_PARC_AGRI_ANON__' + yr + '/MapServer/WMSServer',
      '1', bbox, i, j),
    legendImg: (yr) => 'https://geoservices.wallonie.be/arcgis/services/AGRICULTURE/SIGEC_PARC_AGRI_ANON__' + yr
      + '/MapServer/WMSServer?service=WMS&version=1.3.0&request=GetLegendGraphic&layer=1&format=image/png',
    attribution: '&copy; SPW Wallonie SIGEC'
  },
  {
    id: 'austria', label: 'ðŸ‡¦ðŸ‡¹ Austria (INVEKOS)', type: 'raster', lang: 'de',
    legendType: 'image', minZoom: 12, countryNum: 40, indicatorColor: '#9C27B0',
    years: Array.from({length:11}, (_,i) => 2015+i), defaultYear: 2024,
    tileUrl: (yr) => {
      const lyr = yr <= 2021 ? 'inspire_schlaege_' + yr + '_polygon'
                             : 'inspire_schlaege_' + yr + '-2_polygon';
      return wms13('https://inspire.lfrz.gv.at/009501/wms', lyr);
    },
    featureInfo: (yr, bbox, i, j) => {
      const lyr = yr <= 2021 ? 'inspire_schlaege_' + yr + '_polygon'
                             : 'inspire_schlaege_' + yr + '-2_polygon';
      return gfi13('https://inspire.lfrz.gv.at/009501/wms', lyr, bbox, i, j);
    },
    legendImg: (yr) => {
      const lyr = yr <= 2021 ? 'inspire_schlaege_' + yr + '_polygon'
                             : 'inspire_schlaege_' + yr + '-2_polygon';
      return 'https://inspire.lfrz.gv.at/009501/wms?service=WMS&version=1.3.0&request=GetLegendGraphic&layer=' + lyr + '&format=image/png';
    },
    attribution: '&copy; AMA/BML Austria INVEKOS'
  },
  {
    id: 'denmark', label: 'ðŸ‡©ðŸ‡° Denmark (FVM Marker)', type: 'raster', lang: 'da',
    legendType: 'image',
    years: Array.from({length:18}, (_,i) => 2008+i), defaultYear: 2025,
    tileUrl: (yr) => wms11('https://geodata.fvm.dk/geoserver/Marker/wms', 'Marker_' + yr),
    featureInfo: (yr, bbox, x, y) => gfi11('https://geodata.fvm.dk/geoserver/Marker/wms',
      'Marker_' + yr, bbox, x, y),
    legendImg: (yr) => 'https://geodata.fvm.dk/geoserver/Marker/wms?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=Marker_' + yr + '&format=image/png',
    attribution: '&copy; <a href="https://fvm.dk">FVM Denmark</a>'
  },
  {
    id: 'luxembourg', label: 'ðŸ‡±ðŸ‡º Luxembourg (ASTA LPIS)', type: 'raster', lang: 'fr',
    legendType: 'image', minZoom: 12, countryNum: 442, indicatorColor: '#00BCD4',
    years: Array.from({length:10}, (_,i) => 2016+i), defaultYear: 2025,
    tileUrl: (yr) => wms13('https://wms.inspire.geoportail.lu/geoserver/af/wms',
      'LU.ExistingLandUseObject_LPIS_' + yr),
    featureInfo: (yr, bbox, i, j) => gfi13('https://wms.inspire.geoportail.lu/geoserver/af/wms',
      'LU.ExistingLandUseObject_LPIS_' + yr, bbox, i, j),
    legendImg: (yr) => 'https://wms.inspire.geoportail.lu/geoserver/af/wms?service=WMS&version=1.3.0&request=GetLegendGraphic&layer=LU.ExistingLandUseObject_LPIS_' + yr + '&format=image/png',
    attribution: '&copy; ASTA Luxembourg'
  },
  {
    id: 'portugal', label: 'ðŸ‡µðŸ‡¹ Portugal (IFAP iSIP)', type: 'raster', lang: 'pt',
    legendType: 'image', minZoom: 12, countryNum: 620, indicatorColor: '#FF5722',
    years: [2017,2018,2019], defaultYear: 2019,
    tileUrl: (yr) => {
      const regions = ['AML','Algarve','Centro','Norte',
        yr <= 2017 ? 'alentejo' : 'Alentejo','RAA','RAM'];
      const layers = regions.map(r => 'isip.data:parcelas.' + r + '.' + yr + 'jun10').join(',');
      return wms11('https://www.ifap.pt/isip/ows/isip.data/wms', layers);
    },
    featureInfo: (yr, bbox, x, y) => {
      const layers = 'isip.data:parcelas.AML.' + yr + 'jun10';
      return gfi11('https://www.ifap.pt/isip/ows/isip.data/wms', layers, bbox, x, y);
    },
    legendImg: (yr) => 'https://www.ifap.pt/isip/ows/isip.data/wms?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=isip.data:parcelas.AML.' + yr + 'jun10&format=image/png',
    attribution: '&copy; IFAP Portugal iSIP'
  },
  {
    id: 'switzerland', label: 'ðŸ‡¨ðŸ‡­ Switzerland (BLW)', type: 'raster', lang: 'de',
    legendType: 'image',
    years: null, defaultYear: null, dataYear: '2025',
    tileUrl: () => wms13('https://wms.geo.admin.ch/', 'ch.blw.landwirtschaftliche-nutzungsflaechen'),
    featureInfo: (yr, bbox, i, j) => gfi13('https://wms.geo.admin.ch/',
      'ch.blw.landwirtschaftliche-nutzungsflaechen', bbox, i, j),
    legendImg: 'https://wms.geo.admin.ch/?service=WMS&version=1.3.0&request=GetLegendGraphic&layer=ch.blw.landwirtschaftliche-nutzungsflaechen&format=image/png',
    attribution: '&copy; <a href="https://geo.admin.ch">swisstopo</a>/BLW'
  },
  {
    id: 'norway', label: 'ðŸ‡³ðŸ‡´ Norway (NIBIO AR5)', type: 'raster', lang: 'no',
    legendType: 'image', minZoom: 15, countryNum: 578, indicatorColor: '#2196F3',
    years: null, defaultYear: null, dataYear: 'current',
    tileUrl: () => wms11('https://wms.nibio.no/cgi-bin/ar5', 'Arealtype'),
    featureInfo: (yr, bbox, x, y) => gfi11('https://wms.nibio.no/cgi-bin/ar5',
      'Arealtype', bbox, x, y).replace('info_format=application/json', 'info_format=application/vnd.ogc.gml'),
    legendImg: 'https://wms.nibio.no/cgi-bin/ar5?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=Arealtype&format=image/png',
    attribution: '&copy; <a href="https://nibio.no">NIBIO</a> Norway'
  },
  // --- Additional European parcel layers (from ARCcrop) ---
  {
    id: 'spain', label: 'ðŸ‡ªðŸ‡¸ Spain (SIGPAC)', type: 'raster', lang: 'es',
    legendType: 'image', minZoom: 12,
    years: null, defaultYear: null, dataYear: '2025',
    tileUrl: () => wms13('https://wms.mapa.gob.es/sigpac/wms', 'AU.Sigpac:recinto'),
    featureInfo: (yr, bbox, i, j) => gfi13('https://wms.mapa.gob.es/sigpac/wms',
      'AU.Sigpac:recinto', bbox, i, j),
    legendImg: 'https://wms.mapa.gob.es/sigpac/wms?service=WMS&version=1.3.0&request=GetLegendGraphic&layer=AU.Sigpac:recinto&format=image/png',
    attribution: '&copy; FEGA/MAPA Spain SIGPAC'
  },
  {
    id: 'czechia', label: 'ðŸ‡¨ðŸ‡¿ Czechia (LPIS)', type: 'raster', lang: 'cs',
    legendType: 'image', minZoom: 12,
    years: null, defaultYear: null, dataYear: '2024',
    tileUrl: () => wms11('https://mze.gov.cz/public/app/wms/public_DPB_PB_OPV.fcgi', 'DPB_UCINNE'),
    featureInfo: (yr, bbox, x, y) => gfi11('https://mze.gov.cz/public/app/wms/public_DPB_PB_OPV.fcgi',
      'DPB_UCINNE', bbox, x, y),
    legendImg: 'https://mze.gov.cz/public/app/wms/public_DPB_PB_OPV.fcgi?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=DPB_UCINNE&format=image/png',
    attribution: '&copy; MZe Czech Republic LPIS'
  },
  {
    id: 'slovenia', label: 'ðŸ‡¸ðŸ‡® Slovenia (GERK)', type: 'raster', lang: 'sl',
    legendType: 'image', minZoom: 12,
    years: null, defaultYear: null, dataYear: '2024',
    tileUrl: () => wms13('https://storitve.eprostor.gov.si/ows-pub-wms/SI.MKGP.GERK/ows', 'RKG_BLOK_GERK'),
    featureInfo: (yr, bbox, i, j) => gfi13('https://storitve.eprostor.gov.si/ows-pub-wms/SI.MKGP.GERK/ows',
      'RKG_BLOK_GERK', bbox, i, j),
    legendImg: 'https://storitve.eprostor.gov.si/ows-pub-wms/SI.MKGP.GERK/ows?service=WMS&version=1.3.0&request=GetLegendGraphic&layer=RKG_BLOK_GERK&format=image/png',
    attribution: '&copy; MKGP Slovenia GERK'
  },
  {
    id: 'croatia', label: 'ðŸ‡­ðŸ‡· Croatia (ARKOD)', type: 'raster', lang: 'hr',
    legendType: 'image', minZoom: 12,
    years: null, defaultYear: null, dataYear: '2024',
    tileUrl: () => wms11('https://servisi.apprrr.hr/NIPP/wms', 'hr.land_parcels'),
    featureInfo: (yr, bbox, x, y) => gfi11('https://servisi.apprrr.hr/NIPP/wms',
      'hr.land_parcels', bbox, x, y),
    legendImg: 'https://servisi.apprrr.hr/NIPP/wms?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=hr.land_parcels&format=image/png',
    attribution: '&copy; APPRRR Croatia ARKOD'
  },
  {
    id: 'estonia', label: 'ðŸ‡ªðŸ‡ª Estonia (GSAA)', type: 'raster', lang: 'et',
    legendType: 'image', minZoom: 12,
    years: null, defaultYear: null, dataYear: '2024',
    tileUrl: () => wms13('https://kls.pria.ee/geoserver/inspire_gsaa/wms', 'inspire_gsaa'),
    featureInfo: (yr, bbox, i, j) => gfi13('https://kls.pria.ee/geoserver/inspire_gsaa/wms',
      'inspire_gsaa', bbox, i, j),
    legendImg: 'https://kls.pria.ee/geoserver/inspire_gsaa/wms?service=WMS&version=1.3.0&request=GetLegendGraphic&layer=inspire_gsaa&format=image/png',
    attribution: '&copy; PRIA Estonia GSAA'
  },
  {
    id: 'latvia', label: 'ðŸ‡±ðŸ‡» Latvia (Field Blocks)', type: 'raster', lang: 'lv',
    legendType: 'image', minZoom: 12,
    years: null, defaultYear: null, dataYear: '2024',
    tileUrl: () => wms11('https://karte.lad.gov.lv/arcgis/services/lauku_bloki/MapServer/WMSServer', '0'),
    featureInfo: (yr, bbox, x, y) => gfi11('https://karte.lad.gov.lv/arcgis/services/lauku_bloki/MapServer/WMSServer',
      '0', bbox, x, y),
    legendImg: 'https://karte.lad.gov.lv/arcgis/services/lauku_bloki/MapServer/WMSServer?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=0&format=image/png',
    attribution: '&copy; LAD Latvia'
  },
  {
    id: 'poland', label: 'ðŸ‡µðŸ‡± Poland (LPIS)', type: 'raster', lang: 'pl',
    legendType: 'image', minZoom: 12,
    years: null, defaultYear: null, dataYear: '2024',
    tileUrl: () => wms11('https://mapy.geoportal.gov.pl/wss/ext/arimr_lpis', '14'),
    featureInfo: (yr, bbox, x, y) => gfi11('https://mapy.geoportal.gov.pl/wss/ext/arimr_lpis',
      '14', bbox, x, y),
    legendImg: 'https://mapy.geoportal.gov.pl/wss/ext/arimr_lpis?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=14&format=image/png',
    attribution: '&copy; ARiMR/GUGiK Poland LPIS'
  },
  {
    id: 'sweden', label: 'ðŸ‡¸ðŸ‡ª Sweden (Jordbruk)', type: 'raster', lang: 'sv',
    legendType: 'image', minZoom: 12,
    years: null, defaultYear: null, dataYear: '2024',
    tileUrl: () => wms11('https://epub.sjv.se/inspire/inspire/wms', 'jordbruksblock'),
    featureInfo: (yr, bbox, x, y) => gfi11('https://epub.sjv.se/inspire/inspire/wms',
      'jordbruksblock', bbox, x, y),
    legendImg: 'https://epub.sjv.se/inspire/inspire/wms?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=jordbruksblock&format=image/png',
    attribution: '&copy; SJV Sweden'
  },
  {
    id: 'finland', label: 'ðŸ‡«ðŸ‡® Finland (Ruokavirasto LPIS)', type: 'raster', lang: 'fi',
    legendType: 'image', minZoom: 12,
    years: [2020, 2021, 2022, 2023, 2024], defaultYear: 2024,
    tileUrl: (yr) => wms13('https://inspire.ruokavirasto-awsa.com/geoserver/wms',
      'inspire:LC.LandCoverSurfaces.LPIS.' + yr),
    featureInfo: (yr, bbox, i, j) => gfi13('https://inspire.ruokavirasto-awsa.com/geoserver/wms',
      'inspire:LC.LandCoverSurfaces.LPIS.' + yr, bbox, i, j),
    legendImg: (yr) => 'https://inspire.ruokavirasto-awsa.com/geoserver/wms?service=WMS&version=1.3.0&request=GetLegendGraphic&layer=inspire:LC.LandCoverSurfaces.LPIS.' + yr + '&format=image/png',
    attribution: '&copy; Ruokavirasto Finland'
  },
  // --- Non-European layers ---
  {
    id: 'usda-cdl', label: 'ðŸ‡ºðŸ‡¸ USA (USDA CDL)', type: 'raster', lang: 'en',
    legendType: 'image',
    years: Array.from({length:16}, (_,i) => 2008+i), defaultYear: 2023,
    tileUrl: (yr) => wms11('https://nassgeodata.gmu.edu/CropScapeService/wms_cdlall.cgi', 'cdl_' + yr),
    featureInfo: (yr, bbox, x, y) => gfi11('https://nassgeodata.gmu.edu/CropScapeService/wms_cdlall.cgi',
      'cdl_' + yr, bbox, x, y),
    legendImg: (yr) => 'https://nassgeodata.gmu.edu/CropScapeService/wms_cdlall.cgi?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=cdl_' + yr + '&format=image/png',
    attribution: '&copy; USDA NASS CropScape'
  },
  {
    id: 'canada', label: 'ðŸ‡¨ðŸ‡¦ Canada (AAFC)', type: 'raster', lang: 'en',
    legendType: 'image',
    years: Array.from({length:16}, (_,i) => 2009+i), defaultYear: 2024,
    tileUrl: (yr) => wms11(
      'https://www.agr.gc.ca/imagery-images/services/annual_crop_inventory/' + yr + '/ImageServer/WMSServer',
      yr + ':annual_crop_inventory'),
    featureInfo: (yr, bbox, x, y) => gfi11(
      'https://www.agr.gc.ca/imagery-images/services/annual_crop_inventory/' + yr + '/ImageServer/WMSServer',
      yr + ':annual_crop_inventory', bbox, x, y),
    legendImg: (yr) => 'https://www.agr.gc.ca/imagery-images/services/annual_crop_inventory/' + yr + '/ImageServer/WMSServer?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=' + yr + ':annual_crop_inventory&format=image/png',
    attribution: '&copy; AAFC Canada Annual Crop Inventory'
  },
  {
    id: 'argentina', label: 'ðŸ‡¦ðŸ‡· Argentina (GeoINTA)', type: 'raster', lang: 'es',
    legendType: 'image',
    years: null, defaultYear: null, dataYear: '2024',
    tileUrl: () => wms13('https://geo-backend.inta.gob.ar/geoserver/wms',
      'geonode:mnc_verano2024_f300268fd112b0ec3ef5f731edb78882'),
    featureInfo: (yr, bbox, i, j) => gfi13('https://geo-backend.inta.gob.ar/geoserver/wms',
      'geonode:mnc_verano2024_f300268fd112b0ec3ef5f731edb78882', bbox, i, j),
    legendImg: 'https://geo-backend.inta.gob.ar/geoserver/wms?service=WMS&version=1.3.0&request=GetLegendGraphic&layer=geonode:mnc_verano2024_f300268fd112b0ec3ef5f731edb78882&format=image/png',
    attribution: '&copy; INTA Argentina'
  },
  // --- Mexico / Central America ---
  {
    id: 'mexico-madmex', label: 'ðŸ‡²ðŸ‡½ Mexico (CONABIO MAD-Mex)', type: 'raster', lang: 'es',
    legendType: 'image',
    years: [2017, 2018], defaultYear: 2018,
    pmtilesFile: (yr) => 'mexico-madmex' + yr + '.pmtiles',
    tileUrl: (yr) => wms11('http://geonode.conabio.gob.mx/geoserver/ows',
      'geonode:National_MAD-Mex_landsat8_lc_' + yr + '_31_classes'),
    featureInfo: (yr, bbox, x, y) => gfi11('http://geonode.conabio.gob.mx/geoserver/ows',
      'geonode:National_MAD-Mex_landsat8_lc_' + yr + '_31_classes', bbox, x, y),
    legendImg: (yr) => 'http://geonode.conabio.gob.mx/geoserver/ows?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=geonode:National_MAD-Mex_landsat8_lc_' + yr + '_31_classes&format=image/png',
    attribution: '&copy; <a href="https://madmex.conabio.gob.mx/">CONABIO</a> MAD-Mex'
  },
  {
    id: 'nalcms', label: 'ðŸŒŽ N. America Land Cover (NALCMS)', type: 'raster', lang: 'en',
    legendType: 'list',
    years: null, defaultYear: null, dataYear: '2020',
    pmtilesFile: () => 'nalcms.pmtiles',
    legendItems: [
      {color:'#003d00',label:'Temperate/Subpolar Needleleaf'},{color:'#006600',label:'Subpolar Taiga'},
      {color:'#008c00',label:'Tropical/Subtropical Broadleaf Evergreen'},{color:'#00b300',label:'Tropical/Subtropical Broadleaf Deciduous'},
      {color:'#00cc00',label:'Temperate/Subpolar Broadleaf Deciduous'},{color:'#59cc00',label:'Mixed Forest'},
      {color:'#996600',label:'Tropical/Subtropical Shrubland'},{color:'#cc9900',label:'Temperate/Subpolar Shrubland'},
      {color:'#e6e600',label:'Tropical/Subtropical Grassland'},{color:'#ffff73',label:'Temperate/Subpolar Grassland'},
      {color:'#b3b300',label:'Subpolar/Polar Shrubland-Lichen-Moss'},{color:'#999900',label:'Subpolar/Polar Grassland-Lichen-Moss'},
      {color:'#808000',label:'Subpolar/Polar Barren-Lichen-Moss'},{color:'#006699',label:'Wetland'},
      {color:'#ffff00',label:'Cropland'},{color:'#993366',label:'Barren Lands'},
      {color:'#e60000',label:'Urban'},{color:'#0000ff',label:'Water'},
      {color:'#ffffff',label:'Snow and Ice'}
    ],
    attribution: '&copy; CEC/USGS/CONABIO NALCMS'
  },
  // --- South America ---
  {
    id: 'brazil-mapbiomas', label: 'ðŸ‡§ðŸ‡· Brazil (MapBiomas)', type: 'raster', lang: 'pt',
    legendType: 'list',
    years: [2020, 2021, 2022, 2023], defaultYear: 2023,
    pmtilesFile: (yr) => 'brazil-mapbiomas' + yr + '.pmtiles',
    legendItems: [
      {color:'#1f8d49',label:'Forest Formation'},{color:'#d6bc74',label:'Savanna Formation'},
      {color:'#519799',label:'Mangrove'},{color:'#04381d',label:'Flood. Forest'},
      {color:'#026975',label:'Flood. Savanna'},{color:'#02d659',label:'Grassland'},
      {color:'#ad975a',label:'Other Non-Forest'},{color:'#fc8114',label:'Pasture'},
      {color:'#e6b655',label:'Sugar Cane'},{color:'#f5b3c8',label:'Other Temp. Crops'},
      {color:'#c27ba0',label:'Soybean'},{color:'#db7093',label:'Rice'},
      {color:'#d082de',label:'Cotton'},{color:'#d68fe2',label:'Other Perennial Crops'},
      {color:'#9065d0',label:'Coffee'},{color:'#f3b4f1',label:'Citrus'},
      {color:'#cca0d4',label:'Cashew'},{color:'#cd49e4',label:'Palm Oil'},
      {color:'#cd49e4',label:'Perennial Crops'},{color:'#fff3bf',label:'Mosaic Ag/Past.'},
      {color:'#aa0000',label:'Urban'},{color:'#d5d5e5',label:'Other Non-Veg.'},
      {color:'#0000ff',label:'Water'},{color:'#8a2be2',label:'Non Observed'}
    ],
    attribution: '&copy; <a href="https://mapbiomas.org">MapBiomas</a> CC-BY-SA 4.0'
  },
  // --- Oceania ---
  {
    id: 'australia', label: 'ðŸ‡¦ðŸ‡º Australia (ABARES)', type: 'raster', lang: 'en',
    legendType: 'image',
    years: null, defaultYear: null, dataYear: '2023',
    tileUrl: () => wms13(
      'https://di-daa.img.arcgis.com/arcgis/services/Land_and_vegetation/Catchment_Scale_Land_Use_Simplified/ImageServer/WMSServer',
      'Catchment_Scale_Land_Use_Simplified'),
    featureInfo: (yr, bbox, i, j) => gfi13(
      'https://di-daa.img.arcgis.com/arcgis/services/Land_and_vegetation/Catchment_Scale_Land_Use_Simplified/ImageServer/WMSServer',
      'Catchment_Scale_Land_Use_Simplified', bbox, i, j),
    legendImg: 'https://di-daa.img.arcgis.com/arcgis/services/Land_and_vegetation/Catchment_Scale_Land_Use_Simplified/ImageServer/WMSServer?service=WMS&version=1.3.0&request=GetLegendGraphic&layer=Catchment_Scale_Land_Use_Simplified&format=image/png',
    attribution: '&copy; ABARES Australia'
  },
  {
    id: 'dea-landcover', label: 'ðŸ‡¦ðŸ‡º Australia Land Cover (DEA)', type: 'raster', lang: 'en',
    legendType: 'image',
    years: Array.from({length:33}, (_,i) => 1988+i), defaultYear: 2020,
    tileUrl: (yr) => wms11('https://ows.dea.ga.gov.au/', 'ga_ls_landcover',
      '&time=' + yr + '-01-01'),
    featureInfo: (yr, bbox, x, y) => gfi11('https://ows.dea.ga.gov.au/',
      'ga_ls_landcover', bbox, x, y, '&time=' + yr + '-01-01'),
    legendImg: 'https://ows.dea.ga.gov.au/legend/ga_ls_landcover/level3/legend.png',
    attribution: '&copy; <a href="https://www.dea.ga.gov.au/">Digital Earth Australia</a> CC-BY 4.0'
  },
  {
    id: 'newzealand', label: 'ðŸ‡³ðŸ‡¿ New Zealand (LCDB)', type: 'raster', lang: 'en',
    legendType: 'image',
    years: null, defaultYear: null, dataYear: '2024',
    tileUrl: () => wms11('https://maps.scinfo.org.nz/lcdb/wms', 'lcdb_lcdb6'),
    featureInfo: (yr, bbox, x, y) => gfi11('https://maps.scinfo.org.nz/lcdb/wms',
      'lcdb_lcdb6', bbox, x, y),
    legendImg: 'https://maps.scinfo.org.nz/lcdb/wms?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=lcdb_lcdb6&format=image/png',
    attribution: '&copy; Manaaki Whenua / Landcare Research NZ'
  },
  // --- Africa ---
  {
    id: 'deafrica-crop', label: 'ðŸŒ Africa Cropland (DE Africa)', type: 'raster', lang: 'en',
    legendType: 'image',
    years: null, defaultYear: null, dataYear: '2019',
    tileUrl: () => wms13('https://ows.digitalearth.africa/wms', 'crop_mask'),
    featureInfo: (yr, bbox, i, j) => gfi13('https://ows.digitalearth.africa/wms',
      'crop_mask', bbox, i, j),
    legendImg: 'https://ows.digitalearth.africa/legend/crop_mask/green/legend.png',
    attribution: '&copy; Digital Earth Africa'
  },
  // --- Asia ---
  {
    id: 'china-clcd', label: 'ðŸ‡¨ðŸ‡³ China Land Cover (CLCD)', type: 'raster', lang: 'zh',
    legendType: 'list',
    years: [2020, 2021, 2022, 2023], defaultYear: 2023,
    pmtilesFile: (yr) => 'china-clcd' + yr + '.pmtiles',
    legendItems: [
      {color:'#ffff00',label:'Cropland'},{color:'#008200',label:'Forest'},
      {color:'#b46432',label:'Shrub'},{color:'#00c800',label:'Grassland'},
      {color:'#0000ff',label:'Water'},{color:'#ffffff',label:'Snow/Ice'},
      {color:'#c89664',label:'Barren'},{color:'#ff0000',label:'Impervious'},
      {color:'#00c8c8',label:'Wetland'}
    ],
    attribution: '&copy; <a href="https://zenodo.org/records/12779975">CLCD</a> Wuhan Univ. CC-BY-4.0'
  },
  {
    id: 'india-bhuvan', label: 'ðŸ‡®ðŸ‡³ India (Bhuvan LULC)', type: 'raster', lang: 'hi',
    legendType: 'image',
    years: null, defaultYear: null, dataYear: '2022',
    pmtilesFile: () => 'india-bhuvan.pmtiles',
    tileUrl: () => wms11('https://bhuvan-ras2.nrsc.gov.in/cgi-bin/LULC250K.exe', 'LULC250K'),
    featureInfo: (yr, bbox, x, y) => gfi11('https://bhuvan-ras2.nrsc.gov.in/cgi-bin/LULC250K.exe',
      'LULC250K', bbox, x, y),
    legendImg: 'https://bhuvan-ras2.nrsc.gov.in/cgi-bin/LULC250K.exe?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=LULC250K&format=image/png',
    attribution: '&copy; NRSC/ISRO Bhuvan'
  },
  {
    id: 'indonesia-klhk', label: 'ðŸ‡®ðŸ‡© Indonesia (KLHK)', type: 'raster', lang: 'id',
    legendType: 'image',
    years: null, defaultYear: null, dataYear: '2024',
    pmtilesFile: () => 'indonesia-klhk.pmtiles',
    tileUrl: () => wms11('https://geoportal.menlhk.go.id/server/services/dunekalks/PL_AR_250K/MapServer/WMSServer', '0'),
    featureInfo: (yr, bbox, x, y) => gfi11('https://geoportal.menlhk.go.id/server/services/dunekalks/PL_AR_250K/MapServer/WMSServer',
      '0', bbox, x, y),
    legendImg: 'https://geoportal.menlhk.go.id/server/services/dunekalks/PL_AR_250K/MapServer/WMSServer?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=0&format=image/png',
    attribution: '&copy; KLHK Indonesia'
  },
  {
    id: 'vietnam-jaxa', label: 'ðŸ‡»ðŸ‡³ Vietnam (JAXA LULC 10m)', type: 'raster', lang: 'vi',
    legendType: 'list',
    years: null, defaultYear: null, dataYear: '2020',
    pmtilesFile: () => 'vietnam-jaxa.pmtiles',
    legendItems: [
      {color:'#0000ff',label:'Water'},{color:'#ff0000',label:'Urban'},
      {color:'#ffff00',label:'Rice Paddy'},{color:'#00b400',label:'Other Crops'},
      {color:'#c8c8c8',label:'Bare'},{color:'#ffc800',label:'Orchards/Plantations'},
      {color:'#c89664',label:'Barren'},{color:'#00c800',label:'Forest'},
      {color:'#006400',label:'Mangrove'},{color:'#00c8c8',label:'Wetland'}
    ],
    attribution: '&copy; JAXA EORC Vietnam LULC'
  },
  {
    id: 'japan-hrlulc', label: 'ðŸ‡¯ðŸ‡µ Japan HRLULC (JAXA)', type: 'raster', lang: 'ja',
    legendType: 'list',
    years: [2020, 2022, 2024], defaultYear: 2024,
    pmtilesFile: (yr) => 'japan-hrlulc' + yr + '.pmtiles',
    legendItems: [
      {color:'#0000ff',label:'Water'},{color:'#ff0000',label:'Urban'},
      {color:'#808080',label:'Bare Land'},{color:'#006400',label:'Deciduous Broadleaf'},
      {color:'#00c800',label:'Deciduous Needleleaf'},{color:'#32b432',label:'Evergreen Broadleaf'},
      {color:'#c8ffc8',label:'Evergreen Needleleaf'},{color:'#ffff00',label:'Rice Paddy'},
      {color:'#ffc800',label:'Other Crops'},{color:'#ffffb4',label:'Grassland'},
      {color:'#dcc896',label:'Bamboo'},{color:'#c89664',label:'Bare Deciduous'},
      {color:'#ffffff',label:'Snow/Ice'},{color:'#00c8c8',label:'Wetland'},
      {color:'#9696ff',label:'Aquaculture'}
    ],
    attribution: '&copy; JAXA EORC HRLULC'
  },
  {
    id: 'japan-cropland', label: 'ðŸ‡¯ðŸ‡µ Japan Cropland 10m', type: 'raster', lang: 'ja',
    legendType: 'list',
    years: null, defaultYear: null, dataYear: '2021',
    pmtilesFile: () => 'japan-cropland.pmtiles',
    legendItems: [
      {color:'#ffff00',label:'Rice Paddy'},{color:'#00c800',label:'Vegetables'},
      {color:'#ffc800',label:'Orchards'},{color:'#c86432',label:'Tea'},
      {color:'#00ff00',label:'Pasture'},{color:'#ff0000',label:'Other Crops'},
      {color:'#9696ff',label:'Flower/Nursery'},{color:'#00c8c8',label:'Aquaculture'},
      {color:'#c8c8c8',label:'Fallow'}
    ],
    attribution: '&copy; <a href="https://doi.org/10.5281/zenodo.7519274">Zenodo</a> CC-BY 4.0'
  },
  {
    id: 'china-cropland10m', label: 'ðŸ‡¨ðŸ‡³ China ChinaCropland10m', type: 'raster', lang: 'zh',
    legendType: 'list',
    years: null, defaultYear: null, dataYear: '2020',
    pmtilesFile: () => 'china-cropland10m.pmtiles',
    legendItems: [
      {color:'#009600',label:'Single Crop'},{color:'#ffff00',label:'Double Crop'},
      {color:'#ffc800',label:'Triple Crop'},{color:'#ff9600',label:'Continuous Crop'},
      {color:'#ff6400',label:'Irrigated'},{color:'#ff3200',label:'Rainfed'},
      {color:'#ff0000',label:'Paddy Rice'},{color:'#c80000',label:'Dry Farming'},
      {color:'#960000',label:'Greenhouse'},{color:'#640000',label:'Orchard/Plantation'}
    ],
    attribution: '&copy; <a href="https://doi.org/10.6084/m9.figshare.24633228">Figshare</a>'
  },
  // --- Africa / Middle East ---
  {
    id: 'southafrica-sanlc', label: 'ðŸ‡¿ðŸ‡¦ South Africa (SANLC)', type: 'raster', lang: 'en',
    legendType: 'list',
    years: null, defaultYear: null, dataYear: '2022',
    pmtilesFile: () => 'southafrica-sanlc.pmtiles',
    legendItems: [
      {color:'#960000',label:'Dense Settlement'},{color:'#ff3232',label:'Built-up'},
      {color:'#006400',label:'Indigenous Forest'},{color:'#006600',label:'Woodland/Open Bush'},
      {color:'#008c00',label:'Thicket/Dense Bush'},{color:'#00cc00',label:'Plantation Forest'},
      {color:'#e6e600',label:'Grassland'},{color:'#b3b300',label:'Shrubland/Low Fynbos'},
      {color:'#ffff00',label:'Commercial Cropland'},{color:'#ffc800',label:'Irrigated Crops'},
      {color:'#ff9600',label:'Subsistence Crops'},{color:'#ff6400',label:'Orchards/Vines'},
      {color:'#0000ff',label:'Water'},{color:'#00c8c8',label:'Wetland'},
      {color:'#c89664',label:'Bare/Erosion'},{color:'#808080',label:'Mines/Quarries'}
    ],
    attribution: '&copy; DFFE South Africa SANLC'
  },
  {
    id: 'kenya-jrc', label: 'ðŸ‡°ðŸ‡ª Kenya (JRC/GEOGLAM Crops)', type: 'raster', lang: 'en',
    legendType: 'list',
    years: null, defaultYear: null, dataYear: '2021',
    pmtilesFile: () => 'kenya-jrc.pmtiles',
    legendItems: [
      {color:'#ffff00',label:'Maize'},{color:'#00c800',label:'Beans'},
      {color:'#ffc800',label:'Wheat'},{color:'#c86432',label:'Tea'},
      {color:'#00ff00',label:'Sugarcane'},{color:'#ff0000',label:'Other Crops'},
      {color:'#00c8c8',label:'Rice'},{color:'#c8c8c8',label:'Non-crop'}
    ],
    attribution: '&copy; JRC/EC GEOGLAM'
  },
  {
    id: 'wapor-lcc', label: 'ðŸŒ Africa/ME (WaPOR Land Cover)', type: 'raster', lang: 'en',
    legendType: 'image',
    years: null, defaultYear: null, dataYear: '2021',
    pmtilesFile: () => 'wapor-lcc.pmtiles',
    tileUrl: () => wms11('https://io.apps.fao.org/geoserver/wms', 'WAPOR_2:L2_LCC_A'),
    featureInfo: (yr, bbox, x, y) => gfi11('https://io.apps.fao.org/geoserver/wms',
      'WAPOR_2:L2_LCC_A', bbox, x, y),
    legendImg: 'https://io.apps.fao.org/geoserver/wms?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=WAPOR_2:L2_LCC_A&format=image/png',
    attribution: '&copy; <a href="https://wapor.apps.fao.org">FAO WaPOR</a>'
  },
  {
    id: 'turkey-corine', label: 'ðŸ‡¹ðŸ‡· Turkey (CORINE 2018)', type: 'raster', lang: 'tr',
    legendType: 'image',
    years: null, defaultYear: null, dataYear: '2018',
    pmtilesFile: () => 'turkey-corine.pmtiles',
    tileUrl: () => wms11('https://image.discomap.eea.europa.eu/arcgis/services/Corine/CLC2018_WM/MapServer/WMSServer', '12'),
    featureInfo: (yr, bbox, x, y) => gfi11('https://image.discomap.eea.europa.eu/arcgis/services/Corine/CLC2018_WM/MapServer/WMSServer',
      '12', bbox, x, y),
    legendImg: 'https://image.discomap.eea.europa.eu/arcgis/services/Corine/CLC2018_WM/MapServer/WMSServer?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=12&format=image/png',
    attribution: '&copy; Copernicus CORINE Land Cover'
  },
  // --- Global layers ---
  {
    id: 'modis-landcover', label: 'ðŸ›°ï¸ MODIS Land Cover (Global)', type: 'raster', lang: 'en',
    legendType: 'image',
    years: Array.from({length:24}, (_,i) => 2001+i), defaultYear: 2023,
    tileUrl: (yr) => wms11('https://gibs.earthdata.nasa.gov/wms/epsg3857/best/wms.cgi',
      'MODIS_Combined_L3_IGBP_Land_Cover_Type_Annual', '&time=' + yr + '-01-01'),
    featureInfo: (yr, bbox, x, y) => gfi11('https://gibs.earthdata.nasa.gov/wms/epsg3857/best/wms.cgi',
      'MODIS_Combined_L3_IGBP_Land_Cover_Type_Annual', bbox, x, y, '&time=' + yr + '-01-01'),
    legendImg: 'https://gibs.earthdata.nasa.gov/legends/MODIS_IGBP_Land_Cover_Type_H.png',
    attribution: '&copy; NASA EOSDIS GIBS / MODIS MCD12Q1'
  },
  {
    id: 'gfsad-croplands', label: 'ðŸŒ¾ Global Croplands (GFSAD)', type: 'raster', lang: 'en',
    legendType: 'image',
    years: null, defaultYear: null, dataYear: '2000',
    tileUrl: () => wms11('https://gibs.earthdata.nasa.gov/wms/epsg3857/best/wms.cgi',
      'Agricultural_Lands_Croplands_2000'),
    featureInfo: (yr, bbox, x, y) => gfi11('https://gibs.earthdata.nasa.gov/wms/epsg3857/best/wms.cgi',
      'Agricultural_Lands_Croplands_2000', bbox, x, y),
    legendImg: 'https://gibs.earthdata.nasa.gov/legends/Agricultural_Lands_Croplands_2000_H.png',
    attribution: '&copy; NASA EOSDIS GIBS / Ramankutty et al. 2008'
  },
  {
    id: 'jrc-eucropmap', label: 'ðŸ‡ªðŸ‡º JRC EU Crop Map', type: 'raster', lang: 'en',
    legendType: 'image',
    years: [2018, 2022], defaultYear: 2018,
    tileUrl: (yr) => wms11('https://jeodpp.jrc.ec.europa.eu/jeodpp/services/ows/wms/landcover/eucropmap',
      'LC.EUCROPMAP.' + yr),
    featureInfo: (yr, bbox, x, y) => gfi11('https://jeodpp.jrc.ec.europa.eu/jeodpp/services/ows/wms/landcover/eucropmap',
      'LC.EUCROPMAP.' + yr, bbox, x, y),
    legendImg: (yr) => 'https://jeodpp.jrc.ec.europa.eu/jeodpp/services/ows/wms/landcover/eucropmap?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=LC.EUCROPMAP.' + yr + '&format=image/png',
    attribution: '&copy; JRC/EC EU Crop Map'
  },
  {
    id: 'esa-worldcover', label: 'ðŸ›°ï¸ ESA WorldCover', type: 'raster', lang: 'en',
    legendType: 'image',
    years: [2020, 2021], defaultYear: 2021,
    tileUrl: (yr) => wms11('https://services.terrascope.be/wms/v2', 'WORLDCOVER_' + yr + '_MAP'),
    featureInfo: (yr, bbox, x, y) => gfi11('https://services.terrascope.be/wms/v2',
      'WORLDCOVER_' + yr + '_MAP', bbox, x, y),
    legendImg: (yr) => 'https://services.terrascope.be/wms/v2?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=WORLDCOVER_' + yr + '_MAP&format=image/png',
    attribution: '&copy; ESA/Copernicus WorldCover'
  },
  {
    id: 'worldcereal', label: 'ðŸŒ¾ WorldCereal Temp. Crops', type: 'raster', lang: 'en',
    legendType: 'image',
    years: null, defaultYear: null, dataYear: '2021',
    tileUrl: () => wms11('https://services.terrascope.be/wms/v2', 'WORLDCEREAL_TEMPORARYCROPS_V1'),
    featureInfo: (yr, bbox, x, y) => gfi11('https://services.terrascope.be/wms/v2',
      'WORLDCEREAL_TEMPORARYCROPS_V1', bbox, x, y),
    legendImg: 'https://services.terrascope.be/wms/v2?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=WORLDCEREAL_TEMPORARYCROPS_V1&format=image/png',
    attribution: '&copy; ESA/VITO WorldCereal'
  },
  {
    id: 'worldcereal-maize', label: 'ðŸŒ½ WorldCereal Maize', type: 'raster', lang: 'en',
    legendType: 'image',
    years: null, defaultYear: null, dataYear: '2021',
    tileUrl: () => wms11('https://services.terrascope.be/wms/v2', 'WORLDCEREAL_MAIZE_V1'),
    featureInfo: (yr, bbox, x, y) => gfi11('https://services.terrascope.be/wms/v2',
      'WORLDCEREAL_MAIZE_V1', bbox, x, y),
    legendImg: 'https://services.terrascope.be/wms/v2?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=WORLDCEREAL_MAIZE_V1&format=image/png',
    attribution: '&copy; ESA/VITO WorldCereal'
  },
  {
    id: 'worldcereal-winter', label: 'ðŸŒ¾ WorldCereal Winter Cereals', type: 'raster', lang: 'en',
    legendType: 'image',
    years: null, defaultYear: null, dataYear: '2021',
    tileUrl: () => wms11('https://services.terrascope.be/wms/v2', 'WORLDCEREAL_WINTERCEREALS_V1'),
    featureInfo: (yr, bbox, x, y) => gfi11('https://services.terrascope.be/wms/v2',
      'WORLDCEREAL_WINTERCEREALS_V1', bbox, x, y),
    legendImg: 'https://services.terrascope.be/wms/v2?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=WORLDCEREAL_WINTERCEREALS_V1&format=image/png',
    attribution: '&copy; ESA/VITO WorldCereal'
  },
  {
    id: 'worldcereal-spring', label: 'ðŸŒ¾ WorldCereal Spring Cereals', type: 'raster', lang: 'en',
    legendType: 'image',
    years: null, defaultYear: null, dataYear: '2021',
    tileUrl: () => wms11('https://services.terrascope.be/wms/v2', 'WORLDCEREAL_SPRINGCEREALS_V1'),
    featureInfo: (yr, bbox, x, y) => gfi11('https://services.terrascope.be/wms/v2',
      'WORLDCEREAL_SPRINGCEREALS_V1', bbox, x, y),
    legendImg: 'https://services.terrascope.be/wms/v2?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=WORLDCEREAL_SPRINGCEREALS_V1&format=image/png',
    attribution: '&copy; ESA/VITO WorldCereal'
  }
];

// Add default pmtilesFile to all raster layers that don't have one
LAYERS.forEach(L => {
  if (L.type === 'raster' && !L.pmtilesFile) {
    L.pmtilesFile = (yr) => L.id + (yr ? yr : '') + '.pmtiles';
  }
});

// === Map setup ===
const base = window.location.href.replace(/\/[^/]*$/, '');
function cromePmtilesUrl(yr) { return base + '/crome' + yr + '.pmtiles'; }
const PMTILES_URL = cromePmtilesUrl(2024);
const protocol = new pmtiles.Protocol();
maplibregl.addProtocol('pmtiles', protocol.tile);

// === IndexedDB Tile Cache ===
const TileCache = {
  DB_NAME: 'cropmap-tile-cache',
  DB_VERSION: 1,
  STORE_NAME: 'tiles',
  MAX_AGE_MS: 7 * 24 * 60 * 60 * 1000, // 7 days
  MAX_ENTRIES: 50000,
  _db: null,

  async open() {
    if (this._db) return this._db;
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(this.DB_NAME, this.DB_VERSION);
      req.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains(this.STORE_NAME)) {
          const store = db.createObjectStore(this.STORE_NAME, { keyPath: 'key' });
          store.createIndex('ts', 'ts');
        }
      };
      req.onsuccess = (e) => { this._db = e.target.result; resolve(this._db); };
      req.onerror = () => reject(req.error);
    });
  },

  async get(key) {
    try {
      const db = await this.open();
      return new Promise((resolve) => {
        const tx = db.transaction(this.STORE_NAME, 'readonly');
        const req = tx.objectStore(this.STORE_NAME).get(key);
        req.onsuccess = () => {
          const result = req.result;
          if (result && (Date.now() - result.ts) < this.MAX_AGE_MS) {
            resolve(result.data);
          } else {
            resolve(null);
          }
        };
        req.onerror = () => resolve(null);
      });
    } catch { return null; }
  },

  async put(key, data) {
    try {
      const db = await this.open();
      const tx = db.transaction(this.STORE_NAME, 'readwrite');
      tx.objectStore(this.STORE_NAME).put({ key, data, ts: Date.now() });
    } catch { /* ignore cache write failures */ }
  },

  async evict() {
    try {
      const db = await this.open();
      const tx = db.transaction(this.STORE_NAME, 'readwrite');
      const store = tx.objectStore(this.STORE_NAME);
      const countReq = store.count();
      countReq.onsuccess = () => {
        if (countReq.result > this.MAX_ENTRIES) {
          const idx = store.index('ts');
          const toDelete = countReq.result - this.MAX_ENTRIES + 1000;
          let deleted = 0;
          idx.openCursor().onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor && deleted < toDelete) {
              cursor.delete();
              deleted++;
              cursor.continue();
            }
          };
        }
      };
    } catch { /* ignore eviction failures */ }
  }
};

// Run eviction on startup
TileCache.evict();

// === PMTiles Manifest ===
// Tracks which PMTiles files are available for each dataset/year
const pmtilesManifest = {};
let manifestLoaded = false;

// Load manifest (generated by download_all.sh)
fetch(base + '/pmtiles_manifest.json')
  .then(r => r.ok ? r.json() : null)
  .then(data => {
    if (data && data.files) {
      Object.keys(data.files).forEach(f => { pmtilesManifest[f] = true; });
    }
    manifestLoaded = true;
    console.log('[PMTiles] Manifest loaded:', Object.keys(pmtilesManifest).length, 'files');
  })
  .catch(() => {
    manifestLoaded = true;
    console.log('[PMTiles] No manifest found, will probe individual files');
  });

// Cache of HEAD request results for PMTiles availability
const pmtilesAvailability = {};

async function checkPmtilesAvailable(filename) {
  if (pmtilesManifest[filename]) return true;
  if (pmtilesAvailability[filename] !== undefined) return pmtilesAvailability[filename];
  try {
    const resp = await fetch(base + '/' + filename, { method: 'HEAD' });
    pmtilesAvailability[filename] = resp.ok;
    return resp.ok;
  } catch {
    pmtilesAvailability[filename] = false;
    return false;
  }
}

// Build PMTiles filename for a dataset/year
function pmtilesFilename(id, year) {
  if (!year || year === 'current') return id + '.pmtiles';
  return id + year + '.pmtiles';
}

// Track active data source per layer (for UI indicator)
const layerDataSource = {}; // { layerId: 'pmtiles' | 'wms' | 'vector' }

// Build initial sources and layers for the style
const initSources = {
  osm: {
    type: 'raster',
    tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
    tileSize: 256, maxzoom: 19,
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
  },
  crome: {
    type: 'vector',
    url: 'pmtiles://' + PMTILES_URL,
    attribution: 'CROME &copy; RPA. OGL v3.0.'
  }
};

const initLayers = [
  { id: 'osm-basemap', type: 'raster', source: 'osm', paint: { 'raster-opacity': 1 } },
  {
    id: 'crome-fill', type: 'fill', source: 'crome', 'source-layer': 'crome2024',
    filter: ['==', ['geometry-type'], 'Polygon'],
    paint: {
      'fill-color': ['match', ['get', 'lucode'], ...Object.entries(LUCODE_COLORS).flat(), '#cccccc'],
      'fill-opacity': 0.75
    }
  },
  {
    id: 'crome-outline', type: 'line', source: 'crome', 'source-layer': 'crome2024',
    filter: ['==', ['geometry-type'], 'Polygon'],
    paint: {
      'line-color': '#333',
      'line-width': ['interpolate', ['linear'], ['zoom'], 10, 0, 14, 0.5],
      'line-opacity': 0.3
    }
  }
];

// Add WMS raster and remote vector sources/layers
LAYERS.forEach(L => {
  if (L.type === 'raster') {
    const yr = L.defaultYear;
    if (L.tileUrl) {
      // WMS-backed raster â€” set up WMS tile source (PMTiles will override later if available)
      initSources[L.id] = {
        type: 'raster', tileSize: 256,
        tiles: [L.tileUrl(yr)],
        attribution: L.attribution || ''
      };
    } else {
      // PMTiles-only raster â€” use a placeholder source (will be replaced on activation)
      const fn = typeof L.pmtilesFile === 'function' ? L.pmtilesFile(yr) : (L.id + '.pmtiles');
      initSources[L.id] = {
        type: 'raster',
        url: 'pmtiles://' + base + '/' + fn,
        attribution: L.attribution || ''
      };
    }
    const layerDef = {
      id: L.id + '-wms', type: 'raster', source: L.id,
      paint: { 'raster-opacity': 0 },
      layout: { visibility: 'none' }
    };
    if (L.minZoom) layerDef.minzoom = L.minZoom;
    initLayers.push(layerDef);
  } else if (L.type === 'vector-remote') {
    initSources[L.id] = {
      type: 'vector',
      url: 'pmtiles://' + L.pmtilesUrl,
      bounds: L.id === 'eurocrops' ? [-30, 34, 50, 72] : undefined,
      attribution: L.attribution || ''
    };
    // Use crop-type colors and Europe bbox filter for EuroCrops; plain filter for others
    const isEurocrops = L.id === 'eurocrops';
    const vFilter = ['==', ['geometry-type'], 'Polygon'];
    initLayers.push({
      id: L.id + '-fill', type: 'fill', source: L.id,
      'source-layer': L.sourceLayer,
      filter: vFilter,
      paint: {
        'fill-color': isEurocrops ? EC_COLOR_EXPR : '#66bb6a',
        'fill-opacity': 0.5
      },
      layout: { visibility: 'none' }
    });
    initLayers.push({
      id: L.id + '-outline', type: 'line', source: L.id,
      'source-layer': L.sourceLayer,
      filter: vFilter,
      paint: { 'line-color': isEurocrops ? '#555' : '#2e7d32', 'line-width': 0.5, 'line-opacity': 0.6 },
      layout: { visibility: 'none' }
    });
  }
});

const map = new maplibregl.Map({
  container: 'map',
  style: {
    version: 8,
    glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
    sources: initSources,
    layers: initLayers
  },
  center: [2.0, 50.0],
  zoom: 5,
  maxZoom: 16
});

map.addControl(new maplibregl.NavigationControl(), 'top-right');
map.addControl(new maplibregl.ScaleControl({ maxWidth: 200, unit: 'metric' }), 'bottom-right');

// === Country boundary indicators for low-zoom visibility ===
// Layers with minZoom have WMS server-side scale limits. At low zoom, we show
// a colored country outline so the user can see which countries have data enabled.
let indicatorsReady = false;
map.on('load', () => {
  fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json')
    .then(r => r.json())
    .then(world => {
      const countries = topojson.feature(world, world.objects.countries);
      // Copy the numeric id into properties for filtering
      countries.features.forEach(f => { f.properties.iso_n3 = +f.id; });
      map.addSource('country-indicators', { type: 'geojson', data: countries });

      LAYERS.forEach(L => {
        if (!L.countryNum) return;
        const mz = L.minZoom || 12;
        // Fill layer â€” visible below minZoom, fades out as you approach it
        map.addLayer({
          id: L.id + '-indicator',
          type: 'fill',
          source: 'country-indicators',
          filter: ['==', ['get', 'iso_n3'], L.countryNum],
          paint: {
            'fill-color': L.indicatorColor,
            'fill-opacity': ['interpolate', ['linear'], ['zoom'],
              0, 0.3, mz - 1, 0.15, mz, 0]
          },
          layout: { visibility: 'none' }
        }, 'crome-fill'); // insert before crome layers

        // Border line
        map.addLayer({
          id: L.id + '-indicator-line',
          type: 'line',
          source: 'country-indicators',
          filter: ['==', ['get', 'iso_n3'], L.countryNum],
          paint: {
            'line-color': L.indicatorColor,
            'line-width': 2,
            'line-opacity': ['interpolate', ['linear'], ['zoom'],
              0, 0.7, mz - 1, 0.4, mz, 0]
          },
          layout: { visibility: 'none' }
        }, 'crome-fill');
      });

      indicatorsReady = true;
      // Apply current toggle state to indicators
      LAYERS.forEach(L => {
        if (!L.countryNum) return;
        const vis = layerState[L.id].on ? 'visible' : 'none';
        map.setLayoutProperty(L.id + '-indicator', 'visibility', vis);
        map.setLayoutProperty(L.id + '-indicator-line', 'visibility', vis);
      });
    })
    .catch(err => console.warn('Country indicators failed to load:', err));
});

// === Draggable + collapsible ===
function makeDraggable(panel) {
  const header = panel.querySelector('.panel-header');
  let dragging = false, startX, startY, origLeft, origTop;
  function onStart(e) {
    if (e.target.classList.contains('panel-toggle')) return;
    dragging = true;
    const pt = e.touches ? e.touches[0] : e;
    const rect = panel.getBoundingClientRect();
    startX = pt.clientX; startY = pt.clientY;
    origLeft = rect.left; origTop = rect.top;
    panel.style.right = 'auto'; panel.style.bottom = 'auto';
    panel.style.left = origLeft + 'px'; panel.style.top = origTop + 'px';
    e.preventDefault();
  }
  function onMove(e) {
    if (!dragging) return;
    const pt = e.touches ? e.touches[0] : e;
    let nl = origLeft + (pt.clientX - startX);
    let nt = origTop + (pt.clientY - startY);
    nl = Math.max(0, Math.min(window.innerWidth - 60, nl));
    nt = Math.max(0, Math.min(window.innerHeight - 30, nt));
    panel.style.left = nl + 'px'; panel.style.top = nt + 'px';
  }
  function onEnd() { dragging = false; }
  header.addEventListener('mousedown', onStart);
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onEnd);
  header.addEventListener('touchstart', onStart, { passive: false });
  document.addEventListener('touchmove', onMove, { passive: false });
  document.addEventListener('touchend', onEnd);
}
function makeCollapsible(panel) {
  const btn = panel.querySelector('.panel-toggle');
  btn.addEventListener('click', () => {
    panel.classList.toggle('collapsed');
    btn.innerHTML = panel.classList.contains('collapsed') ? '&#9660;' : '&#9650;';
  });
}
document.querySelectorAll('.panel').forEach(p => { makeDraggable(p); makeCollapsible(p); });

// === Settings gear ===
const settingsPopover = document.getElementById('settings-popover');
const settingsGear = document.getElementById('settings-gear');
settingsGear.addEventListener('click', (e) => {
  e.stopPropagation();
  settingsPopover.classList.toggle('open');
});
document.addEventListener('click', (e) => {
  if (!settingsPopover.contains(e.target) && e.target !== settingsGear) {
    settingsPopover.classList.remove('open');
  }
});
const closeLyrCb = document.getElementById('setting-close-layer');
closeLyrCb.checked = SETTINGS.closeLegendClosesLayer;
closeLyrCb.addEventListener('change', () => {
  SETTINGS.closeLegendClosesLayer = closeLyrCb.checked;
  saveSettings();
});

// === Build layer list UI ===
const layerListEl = document.getElementById('layer-list');
const layerState = {}; // { id: { on, year } }

// Continent sections: first layer ID â†’ section label
const sections = [
  { start: 'crome',          label: 'Europe â€” Classification', open: true },
  { start: 'spain',          label: 'Europe â€” Parcels',        open: false },
  { start: 'usda-cdl',       label: 'Americas',                open: false },
  { start: 'australia',      label: 'Oceania',                 open: false },
  { start: 'deafrica-crop',  label: 'Africa',                  open: false },
  { start: 'modis-landcover', label: 'Global / Satellite',      open: false },
];
const sectionMap = {}; sections.forEach(s => { sectionMap[s.start] = s; });

let currentBody = null; // current continent body container

LAYERS.forEach(L => {
  layerState[L.id] = { on: !!L.defaultOn, year: L.defaultYear };

  // Start a new collapsible continent section?
  if (sectionMap[L.id]) {
    const s = sectionMap[L.id];
    const sec = document.createElement('div');
    sec.className = 'continent-section';

    const hdr = document.createElement('div');
    hdr.className = 'continent-header' + (s.open ? ' open' : '');
    hdr.innerHTML = '<span class="arrow">&#9654;</span> ' + s.label;
    hdr.addEventListener('click', () => {
      hdr.classList.toggle('open');
    });
    sec.appendChild(hdr);

    currentBody = document.createElement('div');
    currentBody.className = 'continent-body';
    sec.appendChild(currentBody);

    layerListEl.appendChild(sec);
  }

  const container = currentBody || layerListEl;
  const row = document.createElement('div');
  row.className = 'layer-row';

  const cb = document.createElement('input');
  cb.type = 'checkbox'; cb.id = 'toggle-' + L.id;
  cb.checked = !!L.defaultOn;
  row.appendChild(cb);

  const lbl = document.createElement('label');
  lbl.htmlFor = cb.id;
  lbl.textContent = L.label;
  row.appendChild(lbl);

  // Source badge (PMT/WMS/VEC indicator)
  const badge = document.createElement('span');
  badge.id = 'badge-' + L.id;
  badge.style.cssText = 'display:none;font-size:8px;padding:1px 3px;border-radius:2px;color:#fff;margin-left:3px;font-weight:bold;vertical-align:middle;';
  row.appendChild(badge);

  if (L.years && L.years.length > 1) {
    const sel = document.createElement('select');
    sel.id = 'year-' + L.id;
    L.years.forEach(yr => {
      const opt = document.createElement('option');
      opt.value = yr; opt.textContent = yr;
      if (yr === L.defaultYear) opt.selected = true;
      sel.appendChild(opt);
    });
    sel.addEventListener('change', () => {
      layerState[L.id].year = parseInt(sel.value);
      if (layerState[L.id].on) {
        if (L.type === 'vector') updateCromeSource(layerState[L.id].year);
        else updateWmsSource(L);
      }
      updateLegend();
    });
    row.appendChild(sel);
  } else if (L.years && L.years.length === 1) {
    const sp = document.createElement('span');
    sp.style.cssText = 'font-size:10px;color:#888;';
    sp.textContent = L.years[0];
    row.appendChild(sp);
  } else if (L.dataYear) {
    const sp = document.createElement('span');
    sp.style.cssText = 'font-size:10px;color:#888;';
    sp.textContent = L.dataYear;
    row.appendChild(sp);
  }

  cb.addEventListener('change', () => {
    layerState[L.id].on = cb.checked;
    if (cb.checked) delete legendClosed[L.id]; // re-show legend when toggled on
    toggleLayer(L, cb.checked);
    updateLegend();
    updateZoomHints();
  });

  container.appendChild(row);

  // Zoom hint for parcel-level layers
  if (L.minZoom) {
    const hint = document.createElement('div');
    hint.className = 'zoom-hint';
    hint.id = 'hint-' + L.id;
    hint.textContent = 'Parcels visible at z' + L.minZoom + '+';
    container.appendChild(hint);
  }
});

// Opacity slider
const opRow = document.createElement('div');
opRow.className = 'opacity-row';
opRow.innerHTML = '<label for="opacity-slider">Opacity:</label>'
  + '<input id="opacity-slider" type="range" min="0" max="100" value="75">'
  + '<span id="opacity-val">75%</span>';
layerListEl.appendChild(opRow);

let currentOpacity = 0.75;
const slider = document.getElementById('opacity-slider');
const opacityVal = document.getElementById('opacity-val');
slider.addEventListener('input', () => {
  currentOpacity = slider.value / 100;
  opacityVal.textContent = slider.value + '%';
  applyOpacity();
});

// === Layer toggle and source update logic ===

// Update the source indicator badge in the layer list
function updateSourceBadge(layerId, source) {
  layerDataSource[layerId] = source;
  const badge = document.getElementById('badge-' + layerId);
  if (!badge) return;
  if (source === 'pmtiles') {
    badge.textContent = 'PMT';
    badge.title = 'Using cached PMTiles';
    badge.style.background = '#4CAF50';
    badge.style.display = 'inline-block';
  } else if (source === 'wms') {
    badge.textContent = 'WMS';
    badge.title = 'Using live WMS';
    badge.style.background = '#FF9800';
    badge.style.display = 'inline-block';
  } else if (source === 'vector') {
    badge.textContent = 'VEC';
    badge.title = 'Vector PMTiles';
    badge.style.background = '#2196F3';
    badge.style.display = 'inline-block';
  } else {
    badge.style.display = 'none';
  }
}

function toggleLayer(L, on) {
  if (L.type === 'vector') {
    ['crome-fill', 'crome-outline'].forEach(lid => {
      if (map.getLayer(lid)) map.setLayoutProperty(lid, 'visibility', on ? 'visible' : 'none');
    });
    if (on) updateSourceBadge(L.id, 'vector');
    else updateSourceBadge(L.id, null);
  } else if (L.type === 'vector-remote') {
    [L.id + '-fill', L.id + '-outline'].forEach(lid => {
      if (map.getLayer(lid)) map.setLayoutProperty(lid, 'visibility', on ? 'visible' : 'none');
    });
    if (on) {
      map.setPaintProperty(L.id + '-fill', 'fill-opacity', currentOpacity * 0.67);
      map.setPaintProperty(L.id + '-outline', 'line-opacity', currentOpacity * 0.8);
      updateSourceBadge(L.id, 'vector');
    } else {
      updateSourceBadge(L.id, null);
    }
  } else {
    // Raster layer â€” try PMTiles first, then WMS
    if (on) {
      activateRasterWithFallback(L);
    } else {
      const lid = L.id + '-wms';
      if (map.getLayer(lid)) map.setLayoutProperty(lid, 'visibility', 'none');
      updateSourceBadge(L.id, null);
    }
  }
  // Toggle country indicator if available
  if (L.countryNum && indicatorsReady) {
    const vis = on ? 'visible' : 'none';
    if (map.getLayer(L.id + '-indicator'))
      map.setLayoutProperty(L.id + '-indicator', 'visibility', vis);
    if (map.getLayer(L.id + '-indicator-line'))
      map.setLayoutProperty(L.id + '-indicator-line', 'visibility', vis);
  }
}

// Try PMTiles first for raster layers, fall back to WMS
async function activateRasterWithFallback(L) {
  const yr = layerState[L.id].year;
  const lid = L.id + '-wms';
  const filename = L.pmtilesFile ? L.pmtilesFile(yr) : pmtilesFilename(L.id, yr);

  // Check if we have a PMTiles file for this dataset/year
  const hasPmtiles = await checkPmtilesAvailable(filename);

  if (hasPmtiles) {
    console.log('[Fallback] Using PMTiles for', L.id, yr);
    // Remove existing WMS layer/source and replace with PMTiles
    if (map.getLayer(lid)) map.removeLayer(lid);
    if (map.getSource(L.id)) map.removeSource(L.id);

    map.addSource(L.id, {
      type: 'raster',
      url: 'pmtiles://' + base + '/' + filename,
      attribution: L.attribution || ''
    });
    const layerDef = {
      id: lid, type: 'raster', source: L.id,
      paint: { 'raster-opacity': currentOpacity },
      layout: { visibility: 'visible' }
    };
    if (L.minZoom) layerDef.minzoom = L.minZoom;
    map.addLayer(layerDef);
    updateSourceBadge(L.id, 'pmtiles');
  } else if (L.tileUrl) {
    console.log('[Fallback] Using WMS for', L.id, yr);
    // Use WMS (already set up, just show it)
    if (map.getLayer(lid)) {
      map.setLayoutProperty(lid, 'visibility', 'visible');
      map.setPaintProperty(lid, 'raster-opacity', currentOpacity);
    }
    updateSourceBadge(L.id, 'wms');
  } else {
    console.log('[Fallback] No PMTiles or WMS available for', L.id, yr);
    updateSourceBadge(L.id, null);
  }
}

// Also check for vector PMTiles for WFS-derived datasets
async function activateVectorPmtilesOrWms(L) {
  const yr = layerState[L.id].year;
  const filename = L.pmtilesFile ? L.pmtilesFile(yr) : pmtilesFilename(L.id, yr);
  const hasPmtiles = await checkPmtilesAvailable(filename);

  if (hasPmtiles) {
    console.log('[Fallback] Found vector PMTiles for', L.id, yr);
    const lid = L.id + '-wms';
    const srcLayer = L.id + (yr && yr !== 'current' ? yr : '');

    // Remove existing WMS layer/source
    if (map.getLayer(lid)) map.removeLayer(lid);
    if (map.getSource(L.id)) map.removeSource(L.id);

    // Add as vector source
    map.addSource(L.id, {
      type: 'vector',
      url: 'pmtiles://' + base + '/' + filename,
      attribution: L.attribution || ''
    });
    map.addLayer({
      id: L.id + '-fill', type: 'fill', source: L.id, 'source-layer': srcLayer,
      filter: ['==', ['geometry-type'], 'Polygon'],
      paint: { 'fill-color': '#66bb6a', 'fill-opacity': currentOpacity * 0.67 },
      layout: { visibility: 'visible' }
    });
    map.addLayer({
      id: L.id + '-outline', type: 'line', source: L.id, 'source-layer': srcLayer,
      filter: ['==', ['geometry-type'], 'Polygon'],
      paint: { 'line-color': '#2e7d32', 'line-width': 0.5, 'line-opacity': currentOpacity * 0.8 },
      layout: { visibility: 'visible' }
    });
    updateSourceBadge(L.id, 'vector');
    return true;
  }
  return false;
}

function updateCromeSource(yr) {
  const srcLayer = 'crome' + yr;
  const url = 'pmtiles://' + cromePmtilesUrl(yr);

  // Remove existing layers and source
  if (map.getLayer('crome-fill')) map.removeLayer('crome-fill');
  if (map.getLayer('crome-outline')) map.removeLayer('crome-outline');
  if (map.getSource('crome')) map.removeSource('crome');

  // Re-add with new year
  map.addSource('crome', {
    type: 'vector', url: url,
    attribution: 'CROME &copy; RPA. OGL v3.0.'
  });
  map.addLayer({
    id: 'crome-fill', type: 'fill', source: 'crome', 'source-layer': srcLayer,
    filter: ['==', ['geometry-type'], 'Polygon'],
    paint: {
      'fill-color': ['match', ['get', 'lucode'], ...Object.entries(LUCODE_COLORS).flat(), '#cccccc'],
      'fill-opacity': currentOpacity
    }
  });
  map.addLayer({
    id: 'crome-outline', type: 'line', source: 'crome', 'source-layer': srcLayer,
    filter: ['==', ['geometry-type'], 'Polygon'],
    paint: {
      'line-color': '#333',
      'line-width': ['interpolate', ['linear'], ['zoom'], 10, 0, 14, 0.5],
      'line-opacity': currentOpacity * 0.4
    }
  });
  updateSourceBadge('crome', 'vector');
}

function updateWmsSource(L) {
  const yr = layerState[L.id].year;
  const lid = L.id + '-wms';

  // Remove layer, remove source
  if (map.getLayer(lid)) map.removeLayer(lid);
  if (map.getLayer(L.id + '-fill')) map.removeLayer(L.id + '-fill');
  if (map.getLayer(L.id + '-outline')) map.removeLayer(L.id + '-outline');
  if (map.getSource(L.id)) map.removeSource(L.id);

  // Re-activate with fallback chain
  activateRasterWithFallback(L);
}

function applyOpacity() {
  LAYERS.forEach(L => {
    if (!layerState[L.id].on) return;
    if (L.type === 'raster') {
      try { map.setPaintProperty(L.id + '-wms', 'raster-opacity', currentOpacity); } catch {}
    } else if (L.type === 'vector-remote') {
      try {
        map.setPaintProperty(L.id + '-fill', 'fill-opacity', currentOpacity * 0.67);
        map.setPaintProperty(L.id + '-outline', 'line-opacity', currentOpacity * 0.8);
      } catch {}
    } else {
      try {
        map.setPaintProperty('crome-fill', 'fill-opacity', currentOpacity);
        map.setPaintProperty('crome-outline', 'line-opacity', currentOpacity * 0.4);
      } catch {}
    }
  });
}

// === Zoom hints for parcel layers ===
function updateZoomHints() {
  const z = map.getZoom();
  LAYERS.forEach(L => {
    if (!L.minZoom) return;
    const hint = document.getElementById('hint-' + L.id);
    if (hint) {
      hint.classList.toggle('visible', layerState[L.id].on && z < L.minZoom);
    }
  });
}
map.on('zoom', updateZoomHints);

// === Dynamic legend â€” stacking closeable cards ===
const legendStack = document.getElementById('legend-stack');
const legendCards = {}; // { layerId: cardElement }
const legendClosed = {}; // { layerId: true } â€” user-dismissed cards stay hidden until layer toggled

function makeLegendCard(id, title, bodyContent) {
  const card = document.createElement('div');
  card.className = 'legend-card';
  card.dataset.layerId = id;

  const hdr = document.createElement('div');
  hdr.className = 'legend-card-header';
  const h = document.createElement('h4');
  h.textContent = title;
  hdr.appendChild(h);
  const closeBtn = document.createElement('button');
  closeBtn.className = 'legend-card-close';
  closeBtn.innerHTML = '&times;';
  closeBtn.title = 'Close legend';
  closeBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    card.remove();
    delete legendCards[id];
    if (SETTINGS.closeLegendClosesLayer) {
      layerState[id].on = false;
      const cb = document.getElementById('toggle-' + id);
      if (cb) cb.checked = false;
      const L = LAYERS.find(l => l.id === id);
      if (L) toggleLayer(L, false);
    } else {
      legendClosed[id] = true;
    }
  });
  hdr.appendChild(closeBtn);
  // Click header to collapse/expand body
  hdr.addEventListener('click', () => { card.classList.toggle('collapsed'); });
  card.appendChild(hdr);

  const body = document.createElement('div');
  body.className = 'legend-card-body';
  body.appendChild(bodyContent);
  card.appendChild(body);
  return card;
}

// === Class toggle state for vector layers ===
// Tracks which land cover classes are hidden per layer
const hiddenClasses = {}; // { layerId: Set(['code1', 'code2', ...]) }

function toggleCromeClass(code) {
  if (!hiddenClasses.crome) hiddenClasses.crome = new Set();
  if (hiddenClasses.crome.has(code)) {
    hiddenClasses.crome.delete(code);
  } else {
    hiddenClasses.crome.add(code);
  }
  applyCromeFilter();
}

function applyCromeFilter() {
  if (!map.getLayer('crome-fill')) return;
  const hidden = hiddenClasses.crome;
  if (!hidden || hidden.size === 0) {
    map.setFilter('crome-fill', ['==', ['geometry-type'], 'Polygon']);
    map.setFilter('crome-outline', ['==', ['geometry-type'], 'Polygon']);
  } else {
    const filter = ['all',
      ['==', ['geometry-type'], 'Polygon'],
      ['!', ['in', ['get', 'lucode'], ['literal', [...hidden]]]]
    ];
    map.setFilter('crome-fill', filter);
    map.setFilter('crome-outline', filter);
  }
}

function toggleEuroCropsClass(key) {
  if (!hiddenClasses.eurocrops) hiddenClasses.eurocrops = new Set();
  if (hiddenClasses.eurocrops.has(key)) {
    hiddenClasses.eurocrops.delete(key);
  } else {
    hiddenClasses.eurocrops.add(key);
  }
  applyEuroCropsFilter();
}

function applyEuroCropsFilter() {
  if (!map.getLayer('eurocrops-fill')) return;
  const hidden = hiddenClasses.eurocrops;
  if (!hidden || hidden.size === 0) {
    map.setFilter('eurocrops-fill', ['==', ['geometry-type'], 'Polygon']);
    map.setFilter('eurocrops-outline', ['==', ['geometry-type'], 'Polygon']);
  } else {
    const filter = ['all',
      ['==', ['geometry-type'], 'Polygon'],
      ['!', ['in', ['get', 'EC_hcat_n'], ['literal', [...hidden]]]]
    ];
    map.setFilter('eurocrops-fill', filter);
    map.setFilter('eurocrops-outline', filter);
  }
}

function buildCromeBody() {
  const frag = document.createDocumentFragment();
  if (!hiddenClasses.crome) hiddenClasses.crome = new Set();

  // Select all / none buttons
  const btnRow = document.createElement('div');
  btnRow.style.cssText = 'display:flex;gap:4px;margin-bottom:4px;';
  const selAll = document.createElement('button');
  selAll.textContent = 'All';
  selAll.style.cssText = 'font-size:9px;padding:1px 4px;cursor:pointer;border:1px solid #ccc;border-radius:2px;background:#f5f5f5;';
  selAll.addEventListener('click', () => {
    hiddenClasses.crome.clear();
    applyCromeFilter();
    updateLegend();
  });
  const selNone = document.createElement('button');
  selNone.textContent = 'None';
  selNone.style.cssText = 'font-size:9px;padding:1px 4px;cursor:pointer;border:1px solid #ccc;border-radius:2px;background:#f5f5f5;';
  selNone.addEventListener('click', () => {
    Object.keys(LUCODE_LABELS).forEach(c => hiddenClasses.crome.add(c));
    applyCromeFilter();
    updateLegend();
  });
  btnRow.appendChild(selAll);
  btnRow.appendChild(selNone);
  frag.appendChild(btnRow);

  CATEGORIES.forEach(cat => {
    const ch = document.createElement('div');
    ch.style.cssText = 'font-weight:bold;margin-top:4px;font-size:11px;cursor:pointer;';
    ch.textContent = cat.name;
    // Click category header to toggle all codes in that category
    ch.addEventListener('click', () => {
      const allHidden = cat.codes.every(c => hiddenClasses.crome.has(c));
      cat.codes.forEach(c => {
        if (allHidden) hiddenClasses.crome.delete(c);
        else hiddenClasses.crome.add(c);
      });
      applyCromeFilter();
      updateLegend();
    });
    frag.appendChild(ch);
    cat.codes.forEach(code => {
      const isHidden = hiddenClasses.crome.has(code);
      const row = document.createElement('div'); row.className = 'legend-row';
      row.style.cssText = 'cursor:pointer;' + (isHidden ? 'opacity:0.35;' : '');
      row.addEventListener('click', () => {
        toggleCromeClass(code);
        updateLegend();
      });
      const sw = document.createElement('div'); sw.className = 'legend-swatch';
      sw.style.background = isHidden ? '#ccc' : (LUCODE_COLORS[code] || '#ccc');
      row.appendChild(sw);
      const lbl = document.createElement('span');
      lbl.textContent = LUCODE_LABELS[code] || code;
      if (isHidden) lbl.style.textDecoration = 'line-through';
      row.appendChild(lbl);
      frag.appendChild(row);
    });
  });
  return frag;
}

function buildEuroCropsBody() {
  const frag = document.createDocumentFragment();
  if (!hiddenClasses.eurocrops) hiddenClasses.eurocrops = new Set();

  // Select all / none buttons
  const btnRow = document.createElement('div');
  btnRow.style.cssText = 'display:flex;gap:4px;margin-bottom:4px;';
  const selAll = document.createElement('button');
  selAll.textContent = 'All';
  selAll.style.cssText = 'font-size:9px;padding:1px 4px;cursor:pointer;border:1px solid #ccc;border-radius:2px;background:#f5f5f5;';
  selAll.addEventListener('click', () => {
    hiddenClasses.eurocrops.clear();
    applyEuroCropsFilter();
    updateLegend();
  });
  const selNone = document.createElement('button');
  selNone.textContent = 'None';
  selNone.style.cssText = 'font-size:9px;padding:1px 4px;cursor:pointer;border:1px solid #ccc;border-radius:2px;background:#f5f5f5;';
  selNone.addEventListener('click', () => {
    Object.keys(EC_COLORS).forEach(k => hiddenClasses.eurocrops.add(k));
    applyEuroCropsFilter();
    updateLegend();
  });
  btnRow.appendChild(selAll);
  btnRow.appendChild(selNone);
  frag.appendChild(btnRow);

  EC_CATEGORIES.forEach(cat => {
    const ch = document.createElement('div');
    ch.style.cssText = 'font-weight:bold;margin-top:4px;font-size:11px;cursor:pointer;';
    ch.textContent = cat.name;
    ch.addEventListener('click', () => {
      const allHidden = cat.key.every(k => hiddenClasses.eurocrops.has(k));
      cat.key.forEach(k => {
        if (allHidden) hiddenClasses.eurocrops.delete(k);
        else hiddenClasses.eurocrops.add(k);
      });
      applyEuroCropsFilter();
      updateLegend();
    });
    frag.appendChild(ch);
    cat.key.forEach(k => {
      const isHidden = hiddenClasses.eurocrops.has(k);
      const row = document.createElement('div'); row.className = 'legend-row';
      row.style.cssText = 'cursor:pointer;' + (isHidden ? 'opacity:0.35;' : '');
      row.addEventListener('click', () => {
        toggleEuroCropsClass(k);
        updateLegend();
      });
      const sw = document.createElement('div'); sw.className = 'legend-swatch';
      sw.style.background = isHidden ? '#ccc' : (EC_COLORS[k] || '#888');
      row.appendChild(sw);
      const lbl = document.createElement('span');
      lbl.textContent = cleanCropName(k);
      if (isHidden) lbl.style.textDecoration = 'line-through';
      row.appendChild(lbl);
      frag.appendChild(row);
    });
  });
  const note = document.createElement('div');
  note.style.cssText = 'font-size:10px;color:#666;margin-top:4px;';
  note.textContent = '16 EU countries Â· click classes to toggle';
  frag.appendChild(note);
  return frag;
}

function buildListBody(items) {
  const frag = document.createDocumentFragment();
  items.forEach(item => {
    const row = document.createElement('div');
    row.className = 'legend-row';
    row.innerHTML = '<div class="legend-swatch" style="background:' + item.color + '"></div>'
      + '<span style="font-size:11px">' + item.label + '</span>';
    frag.appendChild(row);
  });
  return frag;
}

function buildImageBody(imgUrl, alt) {
  const frag = document.createDocumentFragment();
  const img = document.createElement('img');
  img.src = imgUrl; img.alt = alt;
  img.onerror = function() {
    // Remove the card if the image fails to load
    const card = img.closest('.legend-card');
    if (card) { card.remove(); delete legendCards[card.dataset.layerId]; }
  };
  frag.appendChild(img);
  return frag;
}

function updateLegend() {
  // Remove cards for layers that are no longer active
  for (const [id, card] of Object.entries(legendCards)) {
    if (!layerState[id] || !layerState[id].on) {
      card.remove();
      delete legendCards[id];
    }
  }

  // Add or refresh cards for active layers
  LAYERS.forEach(L => {
    if (!layerState[L.id].on) return;
    if (legendClosed[L.id]) return; // user closed this one

    const yr = layerState[L.id].year;
    // If card exists but year changed, remove it so it gets rebuilt
    if (legendCards[L.id] && legendCards[L.id].dataset.year != (yr || '')) {
      legendCards[L.id].remove();
      delete legendCards[L.id];
    }
    if (legendCards[L.id]) return; // already showing

    let title, body;

    if (L.legendType === 'crome') {
      title = 'England â€” CROME ' + (yr || 2024);
      body = buildCromeBody();
    } else if (L.legendType === 'eurocrops') {
      title = 'EuroCrops';
      body = buildEuroCropsBody();
    } else if (L.legendType === 'list') {
      title = L.label + (yr ? ' ' + yr : (L.dataYear ? ' ' + L.dataYear : ''));
      body = buildListBody(L.legendItems);
    } else if (L.legendType === 'image') {
      try {
        const url = typeof L.legendImg === 'function' ? L.legendImg(yr) : L.legendImg;
        if (!url) return;
        title = L.label + (yr ? ' ' + yr : '');
        body = buildImageBody(url, title);
      } catch(e) { return; }
    } else {
      return;
    }

    const card = makeLegendCard(L.id, title, body);
    card.dataset.year = yr || '';
    legendStack.appendChild(card);
    legendCards[L.id] = card;
  });
}

updateLegend();

// === Unified hover info for all layers ===
const infoEl = document.getElementById('info');

function cleanCropName(s) {
  if (!s) return '';
  return s.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
}

// WMS GetFeatureInfo hover â€” debounced, queries server for feature attributes
let gfiTimer = null;
let gfiController = null;

function lngLatToBbox4326(lngLat, zoom) {
  // Build a small bbox around the click point in EPSG:4326
  // Size scales with zoom level
  const size = 360 / Math.pow(2, zoom) / 256;
  return [
    lngLat.lng - size * 2,
    lngLat.lat - size * 2,
    lngLat.lng + size * 2,
    lngLat.lat + size * 2
  ];
}

function summariseGfiProps(props, lang) {
  // Extract the most useful property from a GFI response and translate
  if (!props || typeof props !== 'object') return null;

  // Switzerland has multilingual fields â€” pick by display language
  if (props['nutzung_de'] || props['nutzung_fr'] || props['nutzung_it']) {
    const langMap = { en: 'nutzung_de', de: 'nutzung_de', fr: 'nutzung_fr', it: 'nutzung_it' };
    const field = langMap[DISPLAY_LANG] || 'nutzung_de';
    const val = props[field] || props['nutzung_de'];
    if (val) return translateCrop(val, DISPLAY_LANG === 'fr' ? 'fr' : 'de');
  }

  // Priority: known crop/land-use field names
  const cropKeys = [
    // Germany DLR (English from server)
    'crop type',
    // Denmark FVM
    'Afgroede',
    // Austria INVEKOS
    'SNAR_BEZEICHNUNG',
    // Netherlands BRP
    'gewas', 'category',
    // Belgium
    'CULT_NOM', 'cult_nom', 'LB_CULT_G', 'CATEGORIE',
    // France RPG
    'libelle', 'code_cultu',
    // Luxembourg
    'description', 'Description',
    // Norway
    'artype_beskrivelse', 'arealtype', 'AREALTYPE',
    // Portugal
    'cultura', 'CULTURA',
    // Finland Ruokavirasto LPIS
    'PERUSLOHKOTUNNUS',
    // Generic
    'GRAY_INDEX', 'class', 'CLASS', 'crop', 'CROP', 'croptype',
    'land_use', 'landuse', 'LANDUSE',
    'lucode', 'LUCODE', 'value', 'VALUE', 'label', 'LABEL',
    'name', 'NAME'];
  for (const k of cropKeys) {
    if (props[k] !== undefined && props[k] !== null && props[k] !== '') {
      const val = String(props[k]).trim();
      return lang ? translateCrop(val, lang) : val;
    }
  }
  // Fallback: first non-id, non-geometry string/number value
  for (const [k, v] of Object.entries(props)) {
    if (['id','fid','gml_id','objectid','shape','geom','geometry','bbox',
         'inspire_id','gml_identifier','geom_date_created','gml_geom',
         'gml_length','geo_id','geo_part_key','log_pkey','fart_id','geo_type',
         'fs_kennung','kz_bio_oepul_jn','journalnr','cvr','markblok','gb',
         'gbanmeldt','marknr','imk_areal','betriebsnummer','bur_nr',
         'nutzungsidentifikator','bewirtschaftungsgrad','flaeche_m2',
         'bezugsjahr','kanton','bff_qualitaet_1','code_programm','programm',
         'id_parcel','surf_parc','culture_d1','culture_d2','code_group',
         'sl_flaeche_brutto_ha','jaar','status','gewascode',
         'artype','artreslag','arskogbon','argrunnf','grenkel','grvanlig',
         'verifiseringsdato','datafangstdato','areal_da','sl_sdeid',
         'informasjon','opphav','klassifiseringsmetode','klassifiseringsmetode_kode',
         'artype_label',
         'tunnus','vuosi','pinta_ala','luomuviljely','kalteva_ala',
         'pohjavesi_ala','natura_ala','suojakaista_m','virkistyspvm'
         ].includes(k.toLowerCase())) continue;
    if (v !== null && v !== undefined && v !== '') {
      const val = String(v).trim();
      return lang ? translateCrop(val, lang) : val;
    }
  }
  return null;
}

map.on('mousemove', e => {
  // Collect info from ALL active layers at hover point
  const parts = [];

  // Vector layers: CROME
  if (layerState.crome && layerState.crome.on && map.getLayer('crome-fill')) {
    const fs = map.queryRenderedFeatures(e.point, { layers: ['crome-fill'] });
    fs.forEach(f => {
      const code = f.properties.lucode;
      parts.push('CROME: ' + (LUCODE_LABELS[code] || code) + ' (' + code + ')');
    });
  }

  // Vector layers: EuroCrops
  if (layerState.eurocrops && layerState.eurocrops.on && map.getLayer('eurocrops-fill')) {
    const fs = map.queryRenderedFeatures(e.point, { layers: ['eurocrops-fill'] });
    fs.forEach(f => {
      const p = f.properties;
      const name = cleanCropName(p.EC_hcat_n) || p.EC_trans_n || '(unknown)';
      parts.push('EuroCrops: ' + name);
    });
  }

  // Show vector results immediately
  if (parts.length > 0) {
    infoEl.style.display = 'block';
    infoEl.innerHTML = parts.map(p => '<div>' + p + '</div>').join('');
    map.getCanvas().style.cursor = 'pointer';
  }

  // WMS layers: query ALL active raster layers via GetFeatureInfo
  const wmsLayers = LAYERS.filter(L =>
    L.type === 'raster' && L.featureInfo && layerState[L.id] && layerState[L.id].on
    && (!L.minZoom || map.getZoom() >= L.minZoom));

  if (wmsLayers.length === 0 && parts.length === 0) {
    infoEl.style.display = 'none';
    map.getCanvas().style.cursor = '';
    return;
  }

  if (wmsLayers.length === 0) return;

  // Debounce WMS queries
  if (gfiTimer) clearTimeout(gfiTimer);
  if (gfiController) gfiController.abort();

  if (parts.length === 0) map.getCanvas().style.cursor = 'crosshair';

  gfiTimer = setTimeout(() => {
    const lngLat = e.lngLat;
    const zoom = map.getZoom();
    const bbox = lngLatToBbox4326(lngLat, zoom);
    gfiController = new AbortController();

    // Fetch all WMS layers in parallel
    const promises = wmsLayers.map(L => {
      const yr = layerState[L.id].year;
      const url = L.featureInfo(yr, bbox, 128, 128);

      function parseGfiResponse(data) {
        const results = [];
        if (data && data.features && data.features.length > 0) {
          data.features.forEach(f => {
            const t = summariseGfiProps(f.properties, L.lang);
            if (t) results.push(L.label + ': ' + t);
          });
        } else if (data && data.type === 'Feature' && data.properties) {
          const t = summariseGfiProps(data.properties, L.lang);
          if (t) results.push(L.label + ': ' + t);
        } else if (typeof data === 'string' && data.trim()) {
          // Try to parse as GML/XML â€” extract known fields
          if (data.includes('<') && data.includes('>')) {
            const xmlProps = {};
            const tagRe = /<([A-Za-z_][A-Za-z0-9_]*)>([^<]+)<\//g;
            let m;
            while ((m = tagRe.exec(data)) !== null) xmlProps[m[1]] = m[2].trim();
            if (Object.keys(xmlProps).length > 0) {
              const t = summariseGfiProps(xmlProps, L.lang);
              if (t) results.push(L.label + ': ' + t);
            }
          }
          if (results.length === 0) {
            const clean = data.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
            if (clean.length > 0 && clean.length < 200) results.push(L.label + ': ' + clean);
          }
        }
        return results;
      }

      return fetch(url, { signal: gfiController.signal })
        .then(r => {
          const ct = r.headers.get('content-type') || '';
          if (ct.includes('json')) return r.json();
          return r.text().then(t => { try { return JSON.parse(t); } catch { return t; } });
        })
        .then(data => parseGfiResponse(data))
        .catch(() => []);
    });

    Promise.all(promises).then(results => {
      const wmsParts = results.flat();
      const allParts = [...parts, ...wmsParts];
      if (allParts.length > 0) {
        infoEl.style.display = 'block';
        infoEl.innerHTML = allParts.map(p => '<div>' + p + '</div>').join('');
        map.getCanvas().style.cursor = 'pointer';
      } else if (parts.length === 0) {
        infoEl.style.display = 'none';
        map.getCanvas().style.cursor = '';
      }
    });
  }, 150);
});

map.on('mouseout', () => {
  if (gfiTimer) clearTimeout(gfiTimer);
  if (gfiController) gfiController.abort();
  infoEl.style.display = 'none';
  map.getCanvas().style.cursor = '';
});

// === Geometry validation on source load ===
// Checks vector features for: wrong geometry type, zero/tiny area, extreme slivers
function ringArea(coords) {
  // Shoelace formula for polygon ring area in degrees^2
  let a = 0;
  for (let i = 0, n = coords.length; i < n - 1; i++) {
    a += coords[i][0] * coords[i + 1][1] - coords[i + 1][0] * coords[i][1];
  }
  return Math.abs(a) / 2;
}

function polyArea(geom) {
  if (!geom || !geom.coordinates) return 0;
  const coords = geom.type === 'MultiPolygon' ? geom.coordinates.flat() : geom.coordinates;
  let area = 0;
  coords.forEach((ring, i) => {
    const a = ringArea(ring);
    area += (i === 0) ? a : -a; // exterior adds, holes subtract
  });
  return area;
}

function bboxAspect(geom) {
  if (!geom || !geom.coordinates) return 1;
  const coords = geom.type === 'MultiPolygon'
    ? geom.coordinates.flat(2) : geom.coordinates.flat();
  let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
  for (let i = 0; i < coords.length; i++) {
    const [x, y] = coords[i];
    if (x < minX) minX = x; if (x > maxX) maxX = x;
    if (y < minY) minY = y; if (y > maxY) maxY = y;
  }
  const dx = maxX - minX, dy = maxY - minY;
  if (dx === 0 && dy === 0) return Infinity;
  if (dx === 0 || dy === 0) return Infinity;
  return Math.max(dx / dy, dy / dx);
}

const validatedSources = new Set();

function validateSourceFeatures(sourceId, sourceLayer) {
  const key = sourceId + '/' + sourceLayer;
  if (validatedSources.has(key)) return;

  const features = map.querySourceFeatures(sourceId, { sourceLayer: sourceLayer });
  if (features.length === 0) return;
  validatedSources.add(key);

  let points = 0, lines = 0, zeroArea = 0, slivers = 0, total = features.length;
  const MIN_AREA = 1e-10;    // ~0.001 sq metres at equator
  const MAX_ASPECT = 100;    // bbox aspect ratio threshold for slivers

  features.forEach(f => {
    const gt = f.geometry.type;
    if (gt === 'Point' || gt === 'MultiPoint') { points++; return; }
    if (gt === 'LineString' || gt === 'MultiLineString') { lines++; return; }
    const a = polyArea(f.geometry);
    if (a < MIN_AREA) { zeroArea++; return; }
    if (bboxAspect(f.geometry) > MAX_ASPECT) slivers++;
  });

  const issues = [];
  if (points) issues.push(points + ' stray point(s)');
  if (lines) issues.push(lines + ' stray line(s)');
  if (zeroArea) issues.push(zeroArea + ' zero-area polygon(s)');
  if (slivers) issues.push(slivers + ' sliver(s) (aspect > ' + MAX_ASPECT + ')');

  if (issues.length) {
    console.warn('[Geo Validation] ' + key + ': ' + total + ' features checked â€” ' + issues.join(', '));
  } else {
    console.log('[Geo Validation] ' + key + ': ' + total + ' features OK');
  }
}

// Run validation when vector sources finish loading tiles
map.on('idle', () => {
  LAYERS.forEach(L => {
    if (L.type === 'vector' && layerState[L.id] && layerState[L.id].on) {
      const yr = layerState[L.id].year || 2024;
      validateSourceFeatures('crome', 'crome' + yr);
    } else if (L.type === 'vector-remote' && layerState[L.id] && layerState[L.id].on) {
      validateSourceFeatures(L.id, L.sourceLayer);
    }
  });
});
</script>
</body>
</html>
