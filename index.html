<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>European Crop Maps</title>
<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css">
<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/pmtiles@3.2.1/dist/pmtiles.js"></script>
<style>
  body { margin: 0; padding: 0; }
  #map { position: absolute; top: 0; bottom: 0; width: 100%; }

  /* === Shared panel styles === */
  .panel {
    position: absolute;
    background: rgba(255,255,255,0.94);
    border-radius: 6px; font: 12px/1.6 system-ui, sans-serif;
    box-shadow: 0 1px 4px rgba(0,0,0,0.25); z-index: 2;
  }
  .panel-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 12px; cursor: grab; user-select: none;
    border-bottom: 1px solid #e0e0e0;
  }
  .panel-header:active { cursor: grabbing; }
  .panel-header h3 { margin: 0; font-size: 13px; flex: 1; }
  .panel-toggle {
    background: none; border: none; cursor: pointer;
    font-size: 14px; color: #666; padding: 0 0 0 8px; line-height: 1;
  }
  .panel-toggle:hover { color: #333; }
  .panel-body { padding: 8px 12px; }
  .panel.collapsed .panel-body { display: none; }
  .panel.collapsed .panel-header { border-bottom: none; }

  /* === Controls panel === */
  #controls { top: 10px; left: 10px; min-width: 210px; }
  #controls .panel-body { max-height: 70vh; overflow-y: auto; }
  .layer-toggle { display: flex; align-items: center; gap: 6px; margin: 3px 0; }
  .layer-toggle input[type="checkbox"] { margin: 0; }
  .layer-toggle label { cursor: pointer; white-space: nowrap; font-size: 11.5px; }
  .opacity-row {
    display: flex; align-items: center; gap: 6px;
    margin-top: 6px; padding-top: 6px; border-top: 1px solid #e0e0e0;
  }
  .opacity-row label { white-space: nowrap; }
  .opacity-row input[type="range"] { width: 90px; cursor: pointer; }
  .opacity-row span { min-width: 30px; text-align: right; font-size: 11px; }

  /* === Legend panel === */
  #legend { bottom: 30px; left: 10px; max-width: 260px; }
  #legend .panel-body { max-height: 45vh; overflow-y: auto; }
  .legend-row { display: flex; align-items: center; gap: 6px; }
  .legend-swatch { width: 14px; height: 14px; border-radius: 2px; flex-shrink: 0; }
  .legend-section { margin-bottom: 8px; }
  .legend-section h4 { margin: 6px 0 2px; font-size: 11.5px; color: #555; }
  .legend-section img { max-width: 230px; display: block; }
  .legend-empty { color: #999; font-style: italic; }

  /* === Info panel === */
  #info {
    position: absolute; top: 10px; right: 50px;
    background: rgba(255,255,255,0.92); padding: 8px 12px;
    border-radius: 6px; font: 12px/1.5 system-ui, sans-serif;
    display: none; box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    max-width: 250px; z-index: 2;
  }
</style>
</head>
<body>
<div id="map"></div>

<div id="controls" class="panel">
  <div class="panel-header">
    <h3>European Crop Maps</h3>
    <button class="panel-toggle" title="Collapse/expand">&#9650;</button>
  </div>
  <div class="panel-body">
    <div class="layer-toggle"><input type="checkbox" id="toggle-crome" checked><label for="toggle-crome">England (CROME 2020)</label></div>
    <div class="layer-toggle"><input type="checkbox" id="toggle-germany"><label for="toggle-germany">Germany (DLR CropTypes)</label></div>
    <div class="layer-toggle"><input type="checkbox" id="toggle-france"><label for="toggle-france">France (RPG)</label></div>
    <div class="layer-toggle"><input type="checkbox" id="toggle-netherlands"><label for="toggle-netherlands">Netherlands (BRP)</label></div>
    <div class="layer-toggle"><input type="checkbox" id="toggle-belgium-fl"><label for="toggle-belgium-fl">Belgium - Flanders (ALV)</label></div>
    <div class="layer-toggle"><input type="checkbox" id="toggle-belgium-wa"><label for="toggle-belgium-wa">Belgium - Wallonia (SIGEC)</label></div>
    <div class="layer-toggle"><input type="checkbox" id="toggle-spain"><label for="toggle-spain">Spain (SIGPAC)</label></div>
    <div class="layer-toggle"><input type="checkbox" id="toggle-ireland"><label for="toggle-ireland">Ireland (DAFM GSAA)</label></div>
    <div class="layer-toggle"><input type="checkbox" id="toggle-jrc"><label for="toggle-jrc">EU-wide (JRC EUCropMap)</label></div>
    <div class="opacity-row">
      <label for="opacity-slider">Opacity:</label>
      <input id="opacity-slider" type="range" min="0" max="100" value="75">
      <span id="opacity-val">75%</span>
    </div>
  </div>
</div>

<div id="legend" class="panel">
  <div class="panel-header">
    <h3>Legend</h3>
    <button class="panel-toggle" title="Collapse/expand">&#9650;</button>
  </div>
  <div class="panel-body">
    <div id="legend-content"><span class="legend-empty">Enable a layer to see its legend</span></div>
  </div>
</div>

<div id="info"></div>

<script>
// === CROME lookup tables ===
const LUCODE_LABELS = {
  "AC01":"Spring Barley","AC03":"Beet","AC04":"Borage","AC05":"Buckwheat",
  "AC06":"Canary Seed","AC07":"Carrot","AC09":"Chicory","AC10":"Daffodil",
  "AC14":"Hemp","AC15":"Lettuce","AC16":"Spring Linseed","AC17":"Maize",
  "AC18":"Millet","AC19":"Spring Oats","AC20":"Onions","AC22":"Parsley",
  "AC23":"Parsnips","AC24":"Spring Rye","AC26":"Spinach","AC27":"Strawberry",
  "AC30":"Spring Triticale","AC32":"Spring Wheat","AC34":"Spring Cabbage",
  "AC35":"Turnip","AC36":"Spring Oilseed","AC37":"Brown Mustard",
  "AC38":"Mustard","AC41":"Radish","AC44":"Potato","AC45":"Tomato",
  "AC50":"Squash","AC52":"Siam Pumpkin","AC58":"Mixed Crop 1",
  "AC59":"Mixed Crop 2","AC60":"Mixed Crop 3","AC61":"Mixed Crop 4",
  "AC62":"Mixed Crop 5","AC63":"Winter Barley","AC64":"Winter Linseed",
  "AC65":"Winter Oats","AC66":"Winter Wheat","AC67":"Winter Oilseed",
  "AC68":"Winter Rye","AC69":"Winter Triticale","AC70":"Winter Cabbage",
  "AC71":"Coriander","AC72":"Corn Gromwell","AC74":"Phacelia","AC81":"Poppy",
  "AC88":"Sunflower","AC90":"Gladioli","AC92":"Sorghum","AC94":"Sweet William",
  "AC100":"Italian Ryegrass","AC00":"Unknown/Mixed Vegetation",
  "CA02":"Cover Crop",
  "LG01":"Chickpea","LG02":"Fenugreek","LG03":"Spring Field Beans",
  "LG04":"Green Beans","LG06":"Lupins","LG07":"Spring Peas","LG08":"Soya",
  "LG09":"Cowpea","LG11":"Lucerne","LG13":"Sainfoin","LG14":"Clover",
  "LG15":"Mixed Leguminous 1","LG16":"Mixed Leguminous 2",
  "LG20":"Winter Field Beans","LG21":"Winter Peas",
  "SR01":"Short Rotation Coppice",
  "FA01":"Fallow Land","HE02":"Heathland/Bracken","HEAT":"Heather",
  "PG01":"Grass",
  "NA01":"Non-vegetated Land","WA00":"Water",
  "TC01":"Perennial Crops/Trees","NU01":"Nursery Crops",
  "WO12":"Trees/Scrubs/Hedgerows"
};

const LUCODE_COLORS = {
  "AC01":"#e6b800","AC63":"#ccaa00","AC32":"#f0d000","AC66":"#d4a017",
  "AC19":"#e8c840","AC65":"#c9a830","AC24":"#d4aa50","AC68":"#b89830",
  "AC30":"#c8a848","AC69":"#a89030","AC17":"#f5c71a","AC03":"#e07020",
  "AC07":"#ff8c00","AC44":"#cd853f","AC20":"#daa520",
  "AC36":"#ffe135","AC67":"#ffd700","AC16":"#e8d44d","AC64":"#d4c030",
  "AC04":"#d2691e","AC05":"#bc8f8f","AC06":"#deb887","AC09":"#8fbc8f",
  "AC10":"#ffff00","AC14":"#9acd32","AC15":"#90ee90","AC18":"#f4a460",
  "AC22":"#3cb371","AC23":"#ffdab9","AC26":"#2e8b57","AC27":"#ff6347",
  "AC34":"#66cdaa","AC70":"#5f9ea0","AC35":"#dda0dd","AC37":"#f0e68c",
  "AC38":"#eee8aa","AC41":"#ff7f7f","AC45":"#ff4500","AC50":"#ff8c69",
  "AC52":"#ffa07a","AC71":"#7fff00","AC72":"#6b8e23","AC74":"#8a2be2",
  "AC81":"#ff1493","AC88":"#ffa500","AC90":"#ff69b4","AC92":"#b8860b",
  "AC94":"#c71585","AC100":"#98fb98","CA02":"#bdb76b",
  "AC58":"#d2b48c","AC59":"#c4a882","AC60":"#b69a76","AC61":"#a88c6a",
  "AC62":"#9a7e5e","AC00":"#808080",
  "LG01":"#556b2f","LG02":"#6b8e23","LG03":"#228b22","LG20":"#006400",
  "LG04":"#32cd32","LG06":"#00fa9a","LG07":"#00ff7f","LG21":"#008b45",
  "LG08":"#3cb371","LG09":"#20b2aa","LG11":"#2e8b57","LG13":"#66cdaa",
  "LG14":"#00cd66","LG15":"#4f7942","LG16":"#3a6b35",
  "SR01":"#8b4513",
  "PG01":"#7cfc00","FA01":"#f5deb3","HE02":"#9370db","HEAT":"#8b668b",
  "NA01":"#a9a9a9","WA00":"#4682b4",
  "TC01":"#006400","NU01":"#228b22","WO12":"#2f4f4f"
};

const CATEGORIES = [
  { name: "Cereal / Arable", codes: ["AC66","AC63","AC32","AC01","AC19","AC65","AC24","AC68","AC30","AC69","AC17","AC67","AC36","AC64","AC16","AC03","AC07","AC44","AC20"] },
  { name: "Other Arable", codes: ["AC04","AC14","AC27","AC81","AC88","AC00"] },
  { name: "Leguminous", codes: ["LG03","LG20","LG07","LG21","LG14","LG11"] },
  { name: "Grassland", codes: ["PG01","FA01","HE02","HEAT"] },
  { name: "Trees / Woodland", codes: ["WO12","TC01","NU01","SR01"] },
  { name: "Other", codes: ["NA01","WA00","CA02"] },
];

// === WMS source helpers ===
function wms11(base, layers) {
  return base + '?service=WMS&version=1.1.1&request=GetMap'
    + '&layers=' + encodeURIComponent(layers) + '&styles=&srs=EPSG:3857'
    + '&bbox={bbox-epsg-3857}&width=256&height=256&format=image/png&transparent=true';
}
function wms13(base, layers) {
  return base + '?service=WMS&version=1.3.0&request=GetMap'
    + '&layers=' + encodeURIComponent(layers) + '&styles=&crs=EPSG:3857'
    + '&bbox={bbox-epsg-3857}&width=256&height=256&format=image/png&transparent=true';
}
function legendUrl11(base, layer) {
  return base + '?service=WMS&version=1.1.1&request=GetLegendGraphic'
    + '&layer=' + encodeURIComponent(layer) + '&format=image/png';
}
function legendUrl13(base, layer) {
  return base + '?service=WMS&version=1.3.0&request=GetLegendGraphic'
    + '&layer=' + encodeURIComponent(layer) + '&format=image/png';
}

// === Layer definitions ===
const LAYER_DEFS = {
  'toggle-crome': {
    label: 'England (CROME 2020)',
    mapLayers: ['crome-fill', 'crome-outline'],
    type: 'vector',
    legendType: 'crome'
  },
  'toggle-germany': {
    label: 'Germany (DLR CropTypes)',
    mapLayers: ['germany-wms'],
    type: 'raster',
    legendType: 'image',
    legendImg: legendUrl11('https://geoservice.dlr.de/eoc/land/wms', 'CROPTYPES_DE_P1Y')
  },
  'toggle-france': {
    label: 'France (RPG)',
    mapLayers: ['france-wms'],
    type: 'raster',
    legendType: 'image',
    legendImg: legendUrl13('https://data.geopf.fr/wms-r/wms', 'LANDUSE.AGRICULTURE.LATEST')
  },
  'toggle-netherlands': {
    label: 'Netherlands (BRP)',
    mapLayers: ['netherlands-wms'],
    type: 'raster',
    legendType: 'image',
    legendImg: legendUrl11('https://service.pdok.nl/rvo/brpgewaspercelen/wms/v1_0', 'BrpGewas')
  },
  'toggle-belgium-fl': {
    label: 'Belgium - Flanders',
    mapLayers: ['belgium-fl-wms'],
    type: 'raster',
    legendType: 'image',
    legendImg: legendUrl13('https://geo.api.vlaanderen.be/ALV/wms', 'LbGebrPerc2024')
  },
  'toggle-belgium-wa': {
    label: 'Belgium - Wallonia',
    mapLayers: ['belgium-wa-wms'],
    type: 'raster',
    legendType: 'image',
    legendImg: 'https://geoservices.wallonie.be/arcgis/services/AGRICULTURE/SIGEC_PARC_AGRI_ANON__2022/MapServer/WMSServer'
      + '?service=WMS&version=1.3.0&request=GetLegendGraphic&layer=1&format=image/png'
  },
  'toggle-spain': {
    label: 'Spain (SIGPAC)',
    mapLayers: ['spain-wms'],
    type: 'raster',
    legendType: 'image',
    legendImg: legendUrl11('https://wms.mapa.gob.es/sigpac/wms', 'AU.Sigpac:linea_declaracion')
  },
  'toggle-ireland': {
    label: 'Ireland (DAFM GSAA)',
    mapLayers: ['ireland-wms'],
    type: 'raster',
    legendType: 'image',
    legendImg: legendUrl13('https://www.inspire.gov.ie/geoserver/inspire_iacsdata/wms', 'LU.IE.GSAA.2024')
  },
  'toggle-jrc': {
    label: 'EU-wide (JRC EUCropMap)',
    mapLayers: ['jrc-wms'],
    type: 'raster',
    legendType: 'image',
    legendImg: legendUrl11('https://jeodpp.jrc.ec.europa.eu/jeodpp/services/ows/wms/landcover/eucropmap', 'LC.EUCROPMAP')
  }
};

// === Map setup ===
const base = window.location.href.replace(/\/[^/]*$/, '');
const PMTILES_URL = base + '/crome2020.pmtiles';

const protocol = new pmtiles.Protocol();
maplibregl.addProtocol('pmtiles', protocol.tile);

const map = new maplibregl.Map({
  container: 'map',
  style: {
    version: 8,
    glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
    sources: {
      osm: {
        type: 'raster',
        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
        tileSize: 256,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        maxzoom: 19
      },
      crome: {
        type: 'vector',
        url: 'pmtiles://' + PMTILES_URL,
        attribution: 'CROME 2020 &copy; RPA. OGL v3.0.'
      },
      germany: {
        type: 'raster', tileSize: 256,
        tiles: [wms11('https://geoservice.dlr.de/eoc/land/wms', 'CROPTYPES_DE_P1Y')],
        attribution: '&copy; <a href="https://geoservice.dlr.de">DLR EOC</a> CC-BY 4.0'
      },
      france: {
        type: 'raster', tileSize: 256,
        tiles: [wms13('https://data.geopf.fr/wms-r/wms', 'LANDUSE.AGRICULTURE.LATEST')],
        attribution: '&copy; <a href="https://geoservices.ign.fr/">IGN</a> Licence Ouverte'
      },
      netherlands: {
        type: 'raster', tileSize: 256,
        tiles: [wms11('https://service.pdok.nl/rvo/brpgewaspercelen/wms/v1_0', 'BrpGewas')],
        attribution: '&copy; <a href="https://www.pdok.nl/">PDOK</a>/RVO CC0'
      },
      'belgium-fl': {
        type: 'raster', tileSize: 256,
        tiles: [wms13('https://geo.api.vlaanderen.be/ALV/wms', 'LbGebrPerc2024')],
        attribution: '&copy; Dept. Landbouw &amp; Visserij Vlaanderen'
      },
      'belgium-wa': {
        type: 'raster', tileSize: 256,
        tiles: [wms13(
          'https://geoservices.wallonie.be/arcgis/services/AGRICULTURE/SIGEC_PARC_AGRI_ANON__2022/MapServer/WMSServer',
          '1')],
        attribution: '&copy; SPW Wallonie SIGEC'
      },
      spain: {
        type: 'raster', tileSize: 256,
        tiles: [wms11('https://wms.mapa.gob.es/sigpac/wms', 'AU.Sigpac:linea_declaracion')],
        attribution: '&copy; <a href="https://www.fega.gob.es/">FEGA</a> SIGPAC'
      },
      ireland: {
        type: 'raster', tileSize: 256,
        tiles: [wms13('https://www.inspire.gov.ie/geoserver/inspire_iacsdata/wms', 'LU.IE.GSAA.2024')],
        attribution: '&copy; DAFM Ireland GSAA'
      },
      jrc: {
        type: 'raster', tileSize: 256,
        tiles: [wms11(
          'https://jeodpp.jrc.ec.europa.eu/jeodpp/services/ows/wms/landcover/eucropmap',
          'LC.EUCROPMAP')],
        attribution: '&copy; <a href="https://data.jrc.ec.europa.eu/">JRC</a> EUCropMap CC-BY 4.0'
      }
    },
    layers: [
      { id: 'osm-basemap', type: 'raster', source: 'osm', paint: { 'raster-opacity': 1 } },
      {
        id: 'crome-fill', type: 'fill', source: 'crome', 'source-layer': 'crome2020',
        paint: {
          'fill-color': ['match', ['get', 'lucode'], ...Object.entries(LUCODE_COLORS).flat(), '#cccccc'],
          'fill-opacity': 0.75
        }
      },
      {
        id: 'crome-outline', type: 'line', source: 'crome', 'source-layer': 'crome2020',
        paint: {
          'line-color': '#333',
          'line-width': ['interpolate', ['linear'], ['zoom'], 10, 0, 14, 0.5],
          'line-opacity': 0.3
        }
      },
      { id: 'germany-wms', type: 'raster', source: 'germany', paint: { 'raster-opacity': 0 }, layout: { visibility: 'none' } },
      { id: 'france-wms', type: 'raster', source: 'france', paint: { 'raster-opacity': 0 }, layout: { visibility: 'none' } },
      { id: 'netherlands-wms', type: 'raster', source: 'netherlands', paint: { 'raster-opacity': 0 }, layout: { visibility: 'none' } },
      { id: 'belgium-fl-wms', type: 'raster', source: 'belgium-fl', paint: { 'raster-opacity': 0 }, layout: { visibility: 'none' } },
      { id: 'belgium-wa-wms', type: 'raster', source: 'belgium-wa', paint: { 'raster-opacity': 0 }, layout: { visibility: 'none' } },
      { id: 'spain-wms', type: 'raster', source: 'spain', paint: { 'raster-opacity': 0 }, layout: { visibility: 'none' } },
      { id: 'ireland-wms', type: 'raster', source: 'ireland', paint: { 'raster-opacity': 0 }, layout: { visibility: 'none' } },
      { id: 'jrc-wms', type: 'raster', source: 'jrc', paint: { 'raster-opacity': 0 }, layout: { visibility: 'none' } }
    ]
  },
  center: [2.0, 50.0],
  zoom: 5,
  maxZoom: 16
});

map.addControl(new maplibregl.NavigationControl(), 'top-right');
map.addControl(new maplibregl.ScaleControl({ maxWidth: 200, unit: 'metric' }), 'bottom-right');

// === Draggable + collapsible panels ===
function makeDraggable(panel) {
  const header = panel.querySelector('.panel-header');
  let dragging = false, startX, startY, origLeft, origTop;

  function onStart(e) {
    if (e.target.classList.contains('panel-toggle')) return;
    dragging = true;
    const pt = e.touches ? e.touches[0] : e;
    const rect = panel.getBoundingClientRect();
    startX = pt.clientX; startY = pt.clientY;
    origLeft = rect.left; origTop = rect.top;
    panel.style.right = 'auto'; panel.style.bottom = 'auto';
    panel.style.left = origLeft + 'px'; panel.style.top = origTop + 'px';
    e.preventDefault();
  }
  function onMove(e) {
    if (!dragging) return;
    const pt = e.touches ? e.touches[0] : e;
    let newLeft = origLeft + (pt.clientX - startX);
    let newTop = origTop + (pt.clientY - startY);
    newLeft = Math.max(0, Math.min(window.innerWidth - 60, newLeft));
    newTop = Math.max(0, Math.min(window.innerHeight - 30, newTop));
    panel.style.left = newLeft + 'px';
    panel.style.top = newTop + 'px';
  }
  function onEnd() { dragging = false; }

  header.addEventListener('mousedown', onStart);
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onEnd);
  header.addEventListener('touchstart', onStart, { passive: false });
  document.addEventListener('touchmove', onMove, { passive: false });
  document.addEventListener('touchend', onEnd);
}

function makeCollapsible(panel) {
  const btn = panel.querySelector('.panel-toggle');
  btn.addEventListener('click', () => {
    panel.classList.toggle('collapsed');
    btn.innerHTML = panel.classList.contains('collapsed') ? '&#9660;' : '&#9650;';
  });
}

document.querySelectorAll('.panel').forEach(p => {
  makeDraggable(p);
  makeCollapsible(p);
});

// === Layer toggle + opacity ===
let currentOpacity = 0.75;

function setLayerVisible(toggleId, on) {
  const def = LAYER_DEFS[toggleId];
  for (const layerId of def.mapLayers) {
    if (on) {
      map.setLayoutProperty(layerId, 'visibility', 'visible');
      if (def.type === 'raster') {
        map.setPaintProperty(layerId, 'raster-opacity', currentOpacity);
      }
    } else {
      map.setLayoutProperty(layerId, 'visibility', 'none');
    }
  }
  updateLegend();
}

function applyOpacity() {
  for (const [tid, def] of Object.entries(LAYER_DEFS)) {
    if (!document.getElementById(tid).checked) continue;
    for (const layerId of def.mapLayers) {
      if (def.type === 'raster') {
        map.setPaintProperty(layerId, 'raster-opacity', currentOpacity);
      } else if (layerId.includes('fill')) {
        map.setPaintProperty(layerId, 'fill-opacity', currentOpacity);
      } else if (layerId.includes('outline')) {
        map.setPaintProperty(layerId, 'line-opacity', currentOpacity * 0.4);
      }
    }
  }
}

for (const tid of Object.keys(LAYER_DEFS)) {
  document.getElementById(tid).addEventListener('change', function() {
    setLayerVisible(tid, this.checked);
  });
}

const slider = document.getElementById('opacity-slider');
const opacityVal = document.getElementById('opacity-val');
slider.addEventListener('input', () => {
  currentOpacity = slider.value / 100;
  opacityVal.textContent = slider.value + '%';
  applyOpacity();
});

// === Dynamic legend ===
const legendContent = document.getElementById('legend-content');

function buildCromeLegend() {
  const frag = document.createDocumentFragment();
  const sec = document.createElement('div');
  sec.className = 'legend-section';
  const h = document.createElement('h4');
  h.textContent = 'England - CROME 2020';
  sec.appendChild(h);
  CATEGORIES.forEach(cat => {
    const ch = document.createElement('div');
    ch.style.cssText = 'font-weight:bold; margin-top:4px; font-size:11px;';
    ch.textContent = cat.name;
    sec.appendChild(ch);
    cat.codes.forEach(code => {
      const row = document.createElement('div');
      row.className = 'legend-row';
      const sw = document.createElement('div');
      sw.className = 'legend-swatch';
      sw.style.background = LUCODE_COLORS[code] || '#ccc';
      row.appendChild(sw);
      const lbl = document.createElement('span');
      lbl.textContent = LUCODE_LABELS[code] || code;
      row.appendChild(lbl);
      sec.appendChild(row);
    });
  });
  frag.appendChild(sec);
  return frag;
}

function buildImageLegend(label, imgUrl) {
  const sec = document.createElement('div');
  sec.className = 'legend-section';
  const h = document.createElement('h4');
  h.textContent = label;
  sec.appendChild(h);
  const img = document.createElement('img');
  img.src = imgUrl;
  img.alt = label + ' legend';
  img.onerror = function() { this.style.display = 'none'; };
  sec.appendChild(img);
  return sec;
}

function updateLegend() {
  legendContent.innerHTML = '';
  let any = false;
  for (const [tid, def] of Object.entries(LAYER_DEFS)) {
    if (!document.getElementById(tid).checked) continue;
    any = true;
    if (def.legendType === 'crome') {
      legendContent.appendChild(buildCromeLegend());
    } else if (def.legendType === 'image' && def.legendImg) {
      legendContent.appendChild(buildImageLegend(def.label, def.legendImg));
    }
  }
  if (!any) {
    legendContent.innerHTML = '<span class="legend-empty">Enable a layer to see its legend</span>';
  }
}

updateLegend();

// === Hover info (CROME) ===
const infoEl = document.getElementById('info');
map.on('mousemove', 'crome-fill', e => {
  if (e.features.length) {
    const code = e.features[0].properties.lucode;
    infoEl.style.display = 'block';
    infoEl.textContent = (LUCODE_LABELS[code] || code) + ' (' + code + ')';
    map.getCanvas().style.cursor = 'pointer';
  }
});
map.on('mouseleave', 'crome-fill', () => {
  infoEl.style.display = 'none';
  map.getCanvas().style.cursor = '';
});
</script>
</body>
</html>
