<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>European Crop Maps</title>
<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css">
<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/pmtiles@3.2.1/dist/pmtiles.js"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js"></script>
<style>
  body { margin: 0; padding: 0; }
  #map { position: absolute; top: 0; bottom: 0; width: 100%; }

  .panel {
    position: absolute;
    background: rgba(255,255,255,0.94);
    border-radius: 6px; font: 12px/1.6 system-ui, sans-serif;
    box-shadow: 0 1px 4px rgba(0,0,0,0.25); z-index: 2;
  }
  .panel-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 12px; cursor: grab; user-select: none;
    border-bottom: 1px solid #e0e0e0;
  }
  .panel-header:active { cursor: grabbing; }
  .panel-header h3 { margin: 0; font-size: 13px; flex: 1; }
  .panel-toggle {
    background: none; border: none; cursor: pointer;
    font-size: 14px; color: #666; padding: 0 0 0 8px; line-height: 1;
  }
  .panel-toggle:hover { color: #333; }
  .panel-body { padding: 8px 12px; }
  .panel.collapsed .panel-body { display: none; }
  .panel.collapsed .panel-header { border-bottom: none; }

  #controls { top: 10px; left: 10px; min-width: 250px; }
  #controls .panel-body { max-height: 70vh; overflow-y: auto; }
  .layer-row {
    display: flex; align-items: center; gap: 5px; margin: 3px 0;
  }
  .layer-row input[type="checkbox"] { margin: 0; flex-shrink: 0; }
  .layer-row label { cursor: pointer; white-space: nowrap; font-size: 11.5px; flex: 1; }
  .layer-row select {
    font-size: 10px; padding: 1px 2px; border: 1px solid #ccc;
    border-radius: 3px; background: #fff; cursor: pointer;
  }
  .opacity-row {
    display: flex; align-items: center; gap: 6px;
    margin-top: 6px; padding-top: 6px; border-top: 1px solid #e0e0e0;
  }
  .opacity-row label { white-space: nowrap; }
  .opacity-row input[type="range"] { width: 90px; cursor: pointer; }
  .opacity-row span { min-width: 30px; text-align: right; font-size: 11px; }

  #legend { bottom: 30px; left: 10px; max-width: 260px; }
  #legend .panel-body { max-height: 45vh; overflow-y: auto; }
  .legend-row { display: flex; align-items: center; gap: 6px; }
  .legend-swatch { width: 14px; height: 14px; border-radius: 2px; flex-shrink: 0; }
  .legend-section { margin-bottom: 8px; }
  .legend-section h4 { margin: 6px 0 2px; font-size: 11.5px; color: #555; }
  .legend-section img { max-width: 230px; display: block; }
  .legend-empty { color: #999; font-style: italic; }
  .zoom-hint { font-size: 10px; color: #e67e00; display: none; padding: 4px 0 0; }
  .zoom-hint.visible { display: block; }

  #info {
    position: absolute; top: 10px; right: 50px;
    background: rgba(255,255,255,0.92); padding: 8px 12px;
    border-radius: 6px; font: 12px/1.5 system-ui, sans-serif;
    display: none; box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    max-width: 250px; z-index: 2;
  }
</style>
</head>
<body>
<div id="map"></div>

<div id="controls" class="panel">
  <div class="panel-header">
    <h3>European Crop Maps</h3>
    <button class="panel-toggle" title="Collapse/expand">&#9650;</button>
  </div>
  <div class="panel-body" id="layer-list"></div>
</div>

<div id="legend" class="panel">
  <div class="panel-header">
    <h3>Legend</h3>
    <button class="panel-toggle" title="Collapse/expand">&#9650;</button>
  </div>
  <div class="panel-body">
    <div id="legend-content"><span class="legend-empty">Enable a layer to see its legend</span></div>
  </div>
</div>

<div id="info"></div>

<script>
// === CROME lookup tables ===
const LUCODE_LABELS = {
  "AC01":"Spring Barley","AC03":"Beet","AC04":"Borage","AC05":"Buckwheat",
  "AC06":"Canary Seed","AC07":"Carrot","AC09":"Chicory","AC10":"Daffodil",
  "AC14":"Hemp","AC15":"Lettuce","AC16":"Spring Linseed","AC17":"Maize",
  "AC18":"Millet","AC19":"Spring Oats","AC20":"Onions","AC22":"Parsley",
  "AC23":"Parsnips","AC24":"Spring Rye","AC26":"Spinach","AC27":"Strawberry",
  "AC30":"Spring Triticale","AC32":"Spring Wheat","AC34":"Spring Cabbage",
  "AC35":"Turnip","AC36":"Spring Oilseed","AC37":"Brown Mustard",
  "AC38":"Mustard","AC41":"Radish","AC44":"Potato","AC45":"Tomato",
  "AC50":"Squash","AC52":"Siam Pumpkin","AC58":"Mixed Crop 1",
  "AC59":"Mixed Crop 2","AC60":"Mixed Crop 3","AC61":"Mixed Crop 4",
  "AC62":"Mixed Crop 5","AC63":"Winter Barley","AC64":"Winter Linseed",
  "AC65":"Winter Oats","AC66":"Winter Wheat","AC67":"Winter Oilseed",
  "AC68":"Winter Rye","AC69":"Winter Triticale","AC70":"Winter Cabbage",
  "AC71":"Coriander","AC72":"Corn Gromwell","AC74":"Phacelia","AC81":"Poppy",
  "AC88":"Sunflower","AC90":"Gladioli","AC92":"Sorghum","AC94":"Sweet William",
  "AC100":"Italian Ryegrass","AC00":"Unknown/Mixed Vegetation",
  "CA02":"Cover Crop",
  "LG01":"Chickpea","LG02":"Fenugreek","LG03":"Spring Field Beans",
  "LG04":"Green Beans","LG06":"Lupins","LG07":"Spring Peas","LG08":"Soya",
  "LG09":"Cowpea","LG11":"Lucerne","LG13":"Sainfoin","LG14":"Clover",
  "LG15":"Mixed Leguminous 1","LG16":"Mixed Leguminous 2",
  "LG20":"Winter Field Beans","LG21":"Winter Peas",
  "SR01":"Short Rotation Coppice",
  "FA01":"Fallow Land","HE02":"Heathland/Bracken","HEAT":"Heather",
  "PG01":"Grass",
  "NA01":"Non-vegetated Land","WA00":"Water",
  "TC01":"Perennial Crops/Trees","NU01":"Nursery Crops",
  "WO12":"Trees/Scrubs/Hedgerows"
};
const LUCODE_COLORS = {
  "AC01":"#e6b800","AC63":"#ccaa00","AC32":"#f0d000","AC66":"#d4a017",
  "AC19":"#e8c840","AC65":"#c9a830","AC24":"#d4aa50","AC68":"#b89830",
  "AC30":"#c8a848","AC69":"#a89030","AC17":"#f5c71a","AC03":"#e07020",
  "AC07":"#ff8c00","AC44":"#cd853f","AC20":"#daa520",
  "AC36":"#ffe135","AC67":"#ffd700","AC16":"#e8d44d","AC64":"#d4c030",
  "AC04":"#d2691e","AC05":"#bc8f8f","AC06":"#deb887","AC09":"#8fbc8f",
  "AC10":"#ffff00","AC14":"#9acd32","AC15":"#90ee90","AC18":"#f4a460",
  "AC22":"#3cb371","AC23":"#ffdab9","AC26":"#2e8b57","AC27":"#ff6347",
  "AC34":"#66cdaa","AC70":"#5f9ea0","AC35":"#dda0dd","AC37":"#f0e68c",
  "AC38":"#eee8aa","AC41":"#ff7f7f","AC45":"#ff4500","AC50":"#ff8c69",
  "AC52":"#ffa07a","AC71":"#7fff00","AC72":"#6b8e23","AC74":"#8a2be2",
  "AC81":"#ff1493","AC88":"#ffa500","AC90":"#ff69b4","AC92":"#b8860b",
  "AC94":"#c71585","AC100":"#98fb98","CA02":"#bdb76b",
  "AC58":"#d2b48c","AC59":"#c4a882","AC60":"#b69a76","AC61":"#a88c6a",
  "AC62":"#9a7e5e","AC00":"#808080",
  "LG01":"#556b2f","LG02":"#6b8e23","LG03":"#228b22","LG20":"#006400",
  "LG04":"#32cd32","LG06":"#00fa9a","LG07":"#00ff7f","LG21":"#008b45",
  "LG08":"#3cb371","LG09":"#20b2aa","LG11":"#2e8b57","LG13":"#66cdaa",
  "LG14":"#00cd66","LG15":"#4f7942","LG16":"#3a6b35",
  "SR01":"#8b4513",
  "PG01":"#7cfc00","FA01":"#f5deb3","HE02":"#9370db","HEAT":"#8b668b",
  "NA01":"#a9a9a9","WA00":"#4682b4",
  "TC01":"#006400","NU01":"#228b22","WO12":"#2f4f4f"
};
const CATEGORIES = [
  { name: "Cereal / Arable", codes: ["AC66","AC63","AC32","AC01","AC19","AC65","AC24","AC68","AC30","AC69","AC17","AC67","AC36","AC64","AC16","AC03","AC07","AC44","AC20"] },
  { name: "Other Arable", codes: ["AC04","AC14","AC27","AC81","AC88","AC00"] },
  { name: "Leguminous", codes: ["LG03","LG20","LG07","LG21","LG14","LG11"] },
  { name: "Grassland", codes: ["PG01","FA01","HE02","HEAT"] },
  { name: "Trees / Woodland", codes: ["WO12","TC01","NU01","SR01"] },
  { name: "Other", codes: ["NA01","WA00","CA02"] },
];

// === WMS URL builders ===
function wms11(base, layers, extra) {
  return base + '?service=WMS&version=1.1.1&request=GetMap'
    + '&layers=' + encodeURIComponent(layers) + '&styles=&srs=EPSG:3857'
    + '&bbox={bbox-epsg-3857}&width=256&height=256&format=image/png&transparent=true'
    + (extra || '');
}
function wms13(base, layers) {
  return base + '?service=WMS&version=1.3.0&request=GetMap'
    + '&layers=' + encodeURIComponent(layers) + '&styles=&crs=EPSG:3857'
    + '&bbox={bbox-epsg-3857}&width=256&height=256&format=image/png&transparent=true';
}

// === Layer configuration ===
// Each layer defines how to build its tile URL given a year
const LAYERS = [
  {
    id: 'crome', label: 'England (CROME)', type: 'vector',
    legendType: 'crome', defaultOn: true,
    years: [2020], defaultYear: 2020
  },
  {
    id: 'eurocrops', label: 'EU Field Boundaries (EuroCrops)', type: 'vector-remote',
    legendType: 'eurocrops',
    years: null, defaultYear: null,
    pmtilesUrl: 'https://data.source.coop/cholmes/eurocrops/eurocrops-all.pmtiles',
    sourceLayer: 'eurocrops',
    attribution: '&copy; <a href="https://github.com/maja601/EuroCrops">EuroCrops</a> CC-BY 4.0'
  },
  {
    id: 'germany', label: 'Germany (DLR)', type: 'raster',
    legendType: 'image',
    years: [2017,2018,2019,2020,2021,2022,2023,2024], defaultYear: 2024,
    tileUrl: (yr) => wms11('https://geoservice.dlr.de/eoc/land/wms', 'CROPTYPES_DE_P1Y',
      '&TIME=' + yr + '-01-01T00:00:00Z'),
    legendImg: 'https://geoservice.dlr.de/eoc/land/wms?request=GetLegendGraphic&version=1.1.1&format=image/png&width=20&height=20&layer=CROPTYPES_DE_P1Y',
    attribution: '&copy; <a href="https://geoservice.dlr.de">DLR EOC</a> CC-BY 4.0'
  },
  {
    id: 'france', label: 'France (RPG)', type: 'raster',
    legendType: 'image',
    years: Array.from({length:18}, (_,i) => 2007+i), defaultYear: 2024,
    tileUrl: (yr) => wms13('https://data.geopf.fr/wms-r/wms', 'LANDUSE.AGRICULTURE' + yr),
    legendImg: (yr) => 'https://data.geopf.fr/wms-r/wms?service=WMS&version=1.3.0&request=GetLegendGraphic&layer=LANDUSE.AGRICULTURE' + yr + '&format=image/png',
    attribution: '&copy; <a href="https://geoservices.ign.fr/">IGN</a> RPG Licence Ouverte'
  },
  {
    id: 'netherlands', label: 'Netherlands (BRP)', type: 'raster',
    legendType: 'image', minZoom: 12, countryNum: 528, indicatorColor: '#FF9800',
    years: null, defaultYear: null,
    tileUrl: () => wms11('https://service.pdok.nl/rvo/brpgewaspercelen/wms/v1_0', 'BrpGewas'),
    legendImg: 'https://service.pdok.nl/rvo/brpgewaspercelen/wms/v1_0?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=BrpGewas&format=image/png',
    attribution: '&copy; <a href="https://www.pdok.nl/">PDOK</a>/RVO CC0'
  },
  {
    id: 'belgium-fl', label: 'Belgium - Flanders', type: 'raster',
    legendType: 'image', minZoom: 12, countryNum: 56, indicatorColor: '#E91E63',
    years: Array.from({length:17}, (_,i) => 2008+i), defaultYear: 2024,
    tileUrl: (yr) => wms13('https://geo.api.vlaanderen.be/ALV/wms', 'LbGebrPerc' + yr),
    legendImg: (yr) => 'https://geo.api.vlaanderen.be/ALV/wms?service=WMS&version=1.3.0&request=GetLegendGraphic&layer=LbGebrPerc' + yr + '&format=image/png',
    attribution: '&copy; Dept. Landbouw &amp; Visserij Vlaanderen'
  },
  {
    id: 'belgium-wa', label: 'Belgium - Wallonia', type: 'raster',
    legendType: 'image', minZoom: 12, countryNum: 56, indicatorColor: '#AD1457',
    years: [2019,2020,2021,2022,2023], defaultYear: 2022,
    tileUrl: (yr) => wms13(
      'https://geoservices.wallonie.be/arcgis/services/AGRICULTURE/SIGEC_PARC_AGRI_ANON__' + yr + '/MapServer/WMSServer', '1'),
    legendImg: (yr) => 'https://geoservices.wallonie.be/arcgis/services/AGRICULTURE/SIGEC_PARC_AGRI_ANON__' + yr
      + '/MapServer/WMSServer?service=WMS&version=1.3.0&request=GetLegendGraphic&layer=1&format=image/png',
    attribution: '&copy; SPW Wallonie SIGEC'
  },
  {
    id: 'austria', label: 'Austria (INVEKOS)', type: 'raster',
    legendType: 'image', minZoom: 12, countryNum: 40, indicatorColor: '#9C27B0',
    years: Array.from({length:11}, (_,i) => 2015+i), defaultYear: 2024,
    tileUrl: (yr) => {
      const lyr = yr <= 2021 ? 'inspire_schlaege_' + yr + '_polygon'
                             : 'inspire_schlaege_' + yr + '-2_polygon';
      return wms13('https://inspire.lfrz.gv.at/009501/wms', lyr);
    },
    legendImg: (yr) => {
      const lyr = yr <= 2021 ? 'inspire_schlaege_' + yr + '_polygon'
                             : 'inspire_schlaege_' + yr + '-2_polygon';
      return 'https://inspire.lfrz.gv.at/009501/wms?service=WMS&version=1.3.0&request=GetLegendGraphic&layer=' + lyr + '&format=image/png';
    },
    attribution: '&copy; AMA/BML Austria INVEKOS'
  },
  {
    id: 'czechia', label: 'Czech Republic (LPIS)', type: 'raster',
    legendType: 'image', minZoom: 12, countryNum: 203, indicatorColor: '#3F51B5',
    years: null, defaultYear: null,
    tileUrl: () => wms13('https://mze.gov.cz/public/app/wms/public_DPB_PB_OPV.fcgi', 'DPB_A0'),
    legendImg: 'https://mze.gov.cz/public/app/wms/public_DPB_PB_OPV.fcgi?service=WMS&version=1.3.0&request=GetLegendGraphic&layer=DPB_A0&format=image/png',
    attribution: '&copy; MZe Czech Republic LPIS'
  },
  {
    id: 'denmark', label: 'Denmark (FVM Marker)', type: 'raster',
    legendType: 'image',
    years: Array.from({length:18}, (_,i) => 2008+i), defaultYear: 2025,
    tileUrl: (yr) => wms11('https://geodata.fvm.dk/geoserver/Marker/wms', 'Marker_' + yr),
    legendImg: (yr) => 'https://geodata.fvm.dk/geoserver/Marker/wms?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=Marker_' + yr + '&format=image/png',
    attribution: '&copy; <a href="https://fvm.dk">FVM Denmark</a>'
  },
  {
    id: 'luxembourg', label: 'Luxembourg (ASTA LPIS)', type: 'raster',
    legendType: 'image', minZoom: 12, countryNum: 442, indicatorColor: '#00BCD4',
    years: Array.from({length:10}, (_,i) => 2016+i), defaultYear: 2025,
    tileUrl: (yr) => wms13('https://wms.inspire.geoportail.lu/geoserver/af/wms',
      'LU.ExistingLandUseObject_LPIS_' + yr),
    legendImg: (yr) => 'https://wms.inspire.geoportail.lu/geoserver/af/wms?service=WMS&version=1.3.0&request=GetLegendGraphic&layer=LU.ExistingLandUseObject_LPIS_' + yr + '&format=image/png',
    attribution: '&copy; ASTA Luxembourg'
  },
  {
    id: 'portugal', label: 'Portugal (IFAP iSIP)', type: 'raster',
    legendType: 'image', minZoom: 12, countryNum: 620, indicatorColor: '#FF5722',
    years: [2017,2018,2019], defaultYear: 2019,
    tileUrl: (yr) => {
      const regions = ['AML','Algarve','Centro','Norte',
        yr <= 2017 ? 'alentejo' : 'Alentejo','RAA','RAM'];
      const layers = regions.map(r => 'isip.data:parcelas.' + r + '.' + yr + 'jun10').join(',');
      return wms11('https://www.ifap.pt/isip/ows/isip.data/wms', layers);
    },
    legendImg: (yr) => 'https://www.ifap.pt/isip/ows/isip.data/wms?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=isip.data:parcelas.AML.' + yr + 'jun10&format=image/png',
    attribution: '&copy; IFAP Portugal iSIP'
  },
  {
    id: 'slovenia', label: 'Slovenia (MKGP GERK)', type: 'raster',
    legendType: 'image', minZoom: 12, countryNum: 705, indicatorColor: '#4CAF50',
    years: null, defaultYear: null,
    tileUrl: () => wms13('https://storitve.eprostor.gov.si/ows-pub-wms/SI.MKGP.GERK/ows', 'RKG_BLOK_GERK'),
    legendImg: 'https://storitve.eprostor.gov.si/ows-pub-wms/SI.MKGP.GERK/ows?service=WMS&version=1.3.0&request=GetLegendGraphic&layer=RKG_BLOK_GERK&format=image/png',
    attribution: '&copy; MKGP Slovenia'
  },
  {
    id: 'switzerland', label: 'Switzerland (BLW)', type: 'raster',
    legendType: 'image',
    years: null, defaultYear: null,
    tileUrl: () => wms13('https://wms.geo.admin.ch/', 'ch.blw.landwirtschaftliche-nutzungsflaechen'),
    legendImg: 'https://wms.geo.admin.ch/?service=WMS&version=1.3.0&request=GetLegendGraphic&layer=ch.blw.landwirtschaftliche-nutzungsflaechen&format=image/png',
    attribution: '&copy; <a href="https://geo.admin.ch">swisstopo</a>/BLW'
  },
  {
    id: 'norway', label: 'Norway (NIBIO AR5)', type: 'raster',
    legendType: 'image', minZoom: 12, countryNum: 578, indicatorColor: '#2196F3',
    years: null, defaultYear: null,
    tileUrl: () => wms11('https://wms.nibio.no/cgi-bin/ar5', 'Arealtype'),
    legendImg: 'https://wms.nibio.no/cgi-bin/ar5?service=WMS&version=1.1.1&request=GetLegendGraphic&layer=Arealtype&format=image/png',
    attribution: '&copy; <a href="https://nibio.no">NIBIO</a> Norway'
  }
];

// === Map setup ===
const base = window.location.href.replace(/\/[^/]*$/, '');
const PMTILES_URL = base + '/crome2020.pmtiles';
const protocol = new pmtiles.Protocol();
maplibregl.addProtocol('pmtiles', protocol.tile);

// Build initial sources and layers for the style
const initSources = {
  osm: {
    type: 'raster',
    tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
    tileSize: 256, maxzoom: 19,
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
  },
  crome: {
    type: 'vector',
    url: 'pmtiles://' + PMTILES_URL,
    attribution: 'CROME 2020 &copy; RPA. OGL v3.0.'
  }
};

const initLayers = [
  { id: 'osm-basemap', type: 'raster', source: 'osm', paint: { 'raster-opacity': 1 } },
  {
    id: 'crome-fill', type: 'fill', source: 'crome', 'source-layer': 'crome2020',
    paint: {
      'fill-color': ['match', ['get', 'lucode'], ...Object.entries(LUCODE_COLORS).flat(), '#cccccc'],
      'fill-opacity': 0.75
    }
  },
  {
    id: 'crome-outline', type: 'line', source: 'crome', 'source-layer': 'crome2020',
    paint: {
      'line-color': '#333',
      'line-width': ['interpolate', ['linear'], ['zoom'], 10, 0, 14, 0.5],
      'line-opacity': 0.3
    }
  }
];

// Add WMS raster and remote vector sources/layers
LAYERS.forEach(L => {
  if (L.type === 'raster') {
    const yr = L.defaultYear;
    initSources[L.id] = {
      type: 'raster', tileSize: 256,
      tiles: [L.tileUrl(yr)],
      attribution: L.attribution || ''
    };
    initLayers.push({
      id: L.id + '-wms', type: 'raster', source: L.id,
      paint: { 'raster-opacity': 0 },
      layout: { visibility: 'none' }
    });
  } else if (L.type === 'vector-remote') {
    initSources[L.id] = {
      type: 'vector',
      url: 'pmtiles://' + L.pmtilesUrl,
      attribution: L.attribution || ''
    };
    initLayers.push({
      id: L.id + '-fill', type: 'fill', source: L.id,
      'source-layer': L.sourceLayer,
      paint: { 'fill-color': '#66bb6a', 'fill-opacity': 0.5 },
      layout: { visibility: 'none' }
    });
    initLayers.push({
      id: L.id + '-outline', type: 'line', source: L.id,
      'source-layer': L.sourceLayer,
      paint: { 'line-color': '#2e7d32', 'line-width': 0.5, 'line-opacity': 0.6 },
      layout: { visibility: 'none' }
    });
  }
});

const map = new maplibregl.Map({
  container: 'map',
  style: {
    version: 8,
    glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
    sources: initSources,
    layers: initLayers
  },
  center: [2.0, 50.0],
  zoom: 5,
  maxZoom: 16
});

map.addControl(new maplibregl.NavigationControl(), 'top-right');
map.addControl(new maplibregl.ScaleControl({ maxWidth: 200, unit: 'metric' }), 'bottom-right');

// === Country boundary indicators for low-zoom visibility ===
// Layers with minZoom have WMS server-side scale limits. At low zoom, we show
// a colored country outline so the user can see which countries have data enabled.
let indicatorsReady = false;
map.on('load', () => {
  fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json')
    .then(r => r.json())
    .then(world => {
      const countries = topojson.feature(world, world.objects.countries);
      // Copy the numeric id into properties for filtering
      countries.features.forEach(f => { f.properties.iso_n3 = +f.id; });
      map.addSource('country-indicators', { type: 'geojson', data: countries });

      LAYERS.forEach(L => {
        if (!L.countryNum) return;
        const mz = L.minZoom || 12;
        // Fill layer — visible below minZoom, fades out as you approach it
        map.addLayer({
          id: L.id + '-indicator',
          type: 'fill',
          source: 'country-indicators',
          filter: ['==', ['get', 'iso_n3'], L.countryNum],
          paint: {
            'fill-color': L.indicatorColor,
            'fill-opacity': ['interpolate', ['linear'], ['zoom'],
              0, 0.3, mz - 1, 0.15, mz, 0]
          },
          layout: { visibility: 'none' }
        }, 'crome-fill'); // insert before crome layers

        // Border line
        map.addLayer({
          id: L.id + '-indicator-line',
          type: 'line',
          source: 'country-indicators',
          filter: ['==', ['get', 'iso_n3'], L.countryNum],
          paint: {
            'line-color': L.indicatorColor,
            'line-width': 2,
            'line-opacity': ['interpolate', ['linear'], ['zoom'],
              0, 0.7, mz - 1, 0.4, mz, 0]
          },
          layout: { visibility: 'none' }
        }, 'crome-fill');
      });

      indicatorsReady = true;
      // Apply current toggle state to indicators
      LAYERS.forEach(L => {
        if (!L.countryNum) return;
        const vis = layerState[L.id].on ? 'visible' : 'none';
        map.setLayoutProperty(L.id + '-indicator', 'visibility', vis);
        map.setLayoutProperty(L.id + '-indicator-line', 'visibility', vis);
      });
    })
    .catch(err => console.warn('Country indicators failed to load:', err));
});

// === Draggable + collapsible ===
function makeDraggable(panel) {
  const header = panel.querySelector('.panel-header');
  let dragging = false, startX, startY, origLeft, origTop;
  function onStart(e) {
    if (e.target.classList.contains('panel-toggle')) return;
    dragging = true;
    const pt = e.touches ? e.touches[0] : e;
    const rect = panel.getBoundingClientRect();
    startX = pt.clientX; startY = pt.clientY;
    origLeft = rect.left; origTop = rect.top;
    panel.style.right = 'auto'; panel.style.bottom = 'auto';
    panel.style.left = origLeft + 'px'; panel.style.top = origTop + 'px';
    e.preventDefault();
  }
  function onMove(e) {
    if (!dragging) return;
    const pt = e.touches ? e.touches[0] : e;
    let nl = origLeft + (pt.clientX - startX);
    let nt = origTop + (pt.clientY - startY);
    nl = Math.max(0, Math.min(window.innerWidth - 60, nl));
    nt = Math.max(0, Math.min(window.innerHeight - 30, nt));
    panel.style.left = nl + 'px'; panel.style.top = nt + 'px';
  }
  function onEnd() { dragging = false; }
  header.addEventListener('mousedown', onStart);
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onEnd);
  header.addEventListener('touchstart', onStart, { passive: false });
  document.addEventListener('touchmove', onMove, { passive: false });
  document.addEventListener('touchend', onEnd);
}
function makeCollapsible(panel) {
  const btn = panel.querySelector('.panel-toggle');
  btn.addEventListener('click', () => {
    panel.classList.toggle('collapsed');
    btn.innerHTML = panel.classList.contains('collapsed') ? '&#9660;' : '&#9650;';
  });
}
document.querySelectorAll('.panel').forEach(p => { makeDraggable(p); makeCollapsible(p); });

// === Build layer list UI ===
const layerListEl = document.getElementById('layer-list');
const layerState = {}; // { id: { on, year } }

LAYERS.forEach(L => {
  layerState[L.id] = { on: !!L.defaultOn, year: L.defaultYear };

  const row = document.createElement('div');
  row.className = 'layer-row';

  const cb = document.createElement('input');
  cb.type = 'checkbox'; cb.id = 'toggle-' + L.id;
  cb.checked = !!L.defaultOn;
  row.appendChild(cb);

  const lbl = document.createElement('label');
  lbl.htmlFor = cb.id;
  lbl.textContent = L.label;
  row.appendChild(lbl);

  if (L.years && L.years.length > 1) {
    const sel = document.createElement('select');
    sel.id = 'year-' + L.id;
    L.years.forEach(yr => {
      const opt = document.createElement('option');
      opt.value = yr; opt.textContent = yr;
      if (yr === L.defaultYear) opt.selected = true;
      sel.appendChild(opt);
    });
    sel.addEventListener('change', () => {
      layerState[L.id].year = parseInt(sel.value);
      if (layerState[L.id].on) updateWmsSource(L);
      updateLegend();
    });
    row.appendChild(sel);
  } else if (L.years && L.years.length === 1) {
    const sp = document.createElement('span');
    sp.style.cssText = 'font-size:10px;color:#888;';
    sp.textContent = L.years[0];
    row.appendChild(sp);
  }

  cb.addEventListener('change', () => {
    layerState[L.id].on = cb.checked;
    toggleLayer(L, cb.checked);
    updateLegend();
    updateZoomHints();
  });

  layerListEl.appendChild(row);

  // Zoom hint for parcel-level layers
  if (L.minZoom) {
    const hint = document.createElement('div');
    hint.className = 'zoom-hint';
    hint.id = 'hint-' + L.id;
    hint.textContent = 'Country shown at low zoom; parcels at z' + L.minZoom + '+';
    layerListEl.appendChild(hint);
  }
});

// Opacity slider
const opRow = document.createElement('div');
opRow.className = 'opacity-row';
opRow.innerHTML = '<label for="opacity-slider">Opacity:</label>'
  + '<input id="opacity-slider" type="range" min="0" max="100" value="75">'
  + '<span id="opacity-val">75%</span>';
layerListEl.appendChild(opRow);

let currentOpacity = 0.75;
const slider = document.getElementById('opacity-slider');
const opacityVal = document.getElementById('opacity-val');
slider.addEventListener('input', () => {
  currentOpacity = slider.value / 100;
  opacityVal.textContent = slider.value + '%';
  applyOpacity();
});

// === Layer toggle and source update logic ===
function toggleLayer(L, on) {
  if (L.type === 'vector') {
    ['crome-fill', 'crome-outline'].forEach(lid => {
      map.setLayoutProperty(lid, 'visibility', on ? 'visible' : 'none');
    });
  } else if (L.type === 'vector-remote') {
    [L.id + '-fill', L.id + '-outline'].forEach(lid => {
      map.setLayoutProperty(lid, 'visibility', on ? 'visible' : 'none');
    });
    if (on) {
      map.setPaintProperty(L.id + '-fill', 'fill-opacity', currentOpacity * 0.67);
      map.setPaintProperty(L.id + '-outline', 'line-opacity', currentOpacity * 0.8);
    }
  } else {
    const lid = L.id + '-wms';
    map.setLayoutProperty(lid, 'visibility', on ? 'visible' : 'none');
    if (on) map.setPaintProperty(lid, 'raster-opacity', currentOpacity);
  }
  // Toggle country indicator if available
  if (L.countryNum && indicatorsReady) {
    const vis = on ? 'visible' : 'none';
    if (map.getLayer(L.id + '-indicator'))
      map.setLayoutProperty(L.id + '-indicator', 'visibility', vis);
    if (map.getLayer(L.id + '-indicator-line'))
      map.setLayoutProperty(L.id + '-indicator-line', 'visibility', vis);
  }
}

function updateWmsSource(L) {
  const yr = layerState[L.id].year;
  const lid = L.id + '-wms';
  const newUrl = L.tileUrl(yr);

  // Remove layer, remove source, re-add both
  if (map.getLayer(lid)) map.removeLayer(lid);
  if (map.getSource(L.id)) map.removeSource(L.id);

  map.addSource(L.id, {
    type: 'raster', tileSize: 256,
    tiles: [newUrl],
    attribution: L.attribution || ''
  });
  map.addLayer({
    id: lid, type: 'raster', source: L.id,
    paint: { 'raster-opacity': currentOpacity },
    layout: { visibility: 'visible' }
  });
}

function applyOpacity() {
  LAYERS.forEach(L => {
    if (!layerState[L.id].on) return;
    if (L.type === 'raster') {
      map.setPaintProperty(L.id + '-wms', 'raster-opacity', currentOpacity);
    } else if (L.type === 'vector-remote') {
      map.setPaintProperty(L.id + '-fill', 'fill-opacity', currentOpacity * 0.67);
      map.setPaintProperty(L.id + '-outline', 'line-opacity', currentOpacity * 0.8);
    } else {
      map.setPaintProperty('crome-fill', 'fill-opacity', currentOpacity);
      map.setPaintProperty('crome-outline', 'line-opacity', currentOpacity * 0.4);
    }
  });
}

// === Zoom hints for parcel layers ===
function updateZoomHints() {
  const z = map.getZoom();
  LAYERS.forEach(L => {
    if (!L.minZoom) return;
    const hint = document.getElementById('hint-' + L.id);
    if (hint) {
      hint.classList.toggle('visible', layerState[L.id].on && z < L.minZoom);
    }
  });
}
map.on('zoom', updateZoomHints);

// === Dynamic legend ===
const legendContent = document.getElementById('legend-content');

function buildCromeLegend() {
  const sec = document.createElement('div');
  sec.className = 'legend-section';
  const h = document.createElement('h4'); h.textContent = 'England - CROME 2020';
  sec.appendChild(h);
  CATEGORIES.forEach(cat => {
    const ch = document.createElement('div');
    ch.style.cssText = 'font-weight:bold;margin-top:4px;font-size:11px;';
    ch.textContent = cat.name; sec.appendChild(ch);
    cat.codes.forEach(code => {
      const row = document.createElement('div'); row.className = 'legend-row';
      const sw = document.createElement('div'); sw.className = 'legend-swatch';
      sw.style.background = LUCODE_COLORS[code] || '#ccc'; row.appendChild(sw);
      const lbl = document.createElement('span');
      lbl.textContent = LUCODE_LABELS[code] || code; row.appendChild(lbl);
      sec.appendChild(row);
    });
  });
  return sec;
}

function buildImageLegend(label, imgUrl) {
  const sec = document.createElement('div'); sec.className = 'legend-section';
  const h = document.createElement('h4'); h.textContent = label; sec.appendChild(h);
  const img = document.createElement('img');
  img.src = imgUrl; img.alt = label + ' legend';
  img.onerror = function() {
    this.parentElement.innerHTML += '<span class="legend-empty">Legend not available</span>';
    this.remove();
  };
  sec.appendChild(img);
  return sec;
}

function updateLegend() {
  legendContent.innerHTML = '';
  let any = false;
  LAYERS.forEach(L => {
    if (!layerState[L.id].on) return;
    any = true;
    const yr = layerState[L.id].year;
    if (L.legendType === 'crome') {
      legendContent.appendChild(buildCromeLegend());
    } else if (L.legendType === 'eurocrops') {
      const sec = document.createElement('div'); sec.className = 'legend-section';
      const h = document.createElement('h4'); h.textContent = 'EU Field Boundaries (EuroCrops)'; sec.appendChild(h);
      const row = document.createElement('div'); row.className = 'legend-row';
      const sw = document.createElement('div'); sw.className = 'legend-swatch';
      sw.style.background = '#66bb6a'; sw.style.border = '1px solid #2e7d32'; row.appendChild(sw);
      const lbl = document.createElement('span'); lbl.textContent = 'Field boundary (hover for crop type)'; row.appendChild(lbl);
      sec.appendChild(row);
      const note = document.createElement('div');
      note.style.cssText = 'font-size:10px;color:#666;margin-top:4px;';
      note.textContent = '16 EU countries: AT, BE, DE, DK, EE, ES, FR, HR, LT, LV, NL, RO, SE, SI, SK';
      sec.appendChild(note);
      legendContent.appendChild(sec);
    } else if (L.legendType === 'image') {
      const url = typeof L.legendImg === 'function' ? L.legendImg(yr) : L.legendImg;
      if (url) legendContent.appendChild(buildImageLegend(L.label + (yr ? ' ' + yr : ''), url));
    }
  });
  if (!any) legendContent.innerHTML = '<span class="legend-empty">Enable a layer to see its legend</span>';
}
updateLegend();

// === Hover info ===
const infoEl = document.getElementById('info');
map.on('mousemove', 'crome-fill', e => {
  if (e.features.length) {
    const code = e.features[0].properties.lucode;
    infoEl.style.display = 'block';
    infoEl.textContent = (LUCODE_LABELS[code] || code) + ' (' + code + ')';
    map.getCanvas().style.cursor = 'pointer';
  }
});
map.on('mouseleave', 'crome-fill', () => {
  infoEl.style.display = 'none';
  map.getCanvas().style.cursor = '';
});
// EuroCrops hover — clean up underscore-delimited names to readable English
function cleanCropName(s) {
  if (!s) return '';
  return s.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
}
map.on('mousemove', 'eurocrops-fill', e => {
  if (e.features.length) {
    const p = e.features[0].properties;
    const name = cleanCropName(p.EC_hcat_n) || p.EC_trans_n || '(unknown)';
    infoEl.style.display = 'block';
    infoEl.textContent = name;
    map.getCanvas().style.cursor = 'pointer';
  }
});
map.on('mouseleave', 'eurocrops-fill', () => {
  infoEl.style.display = 'none';
  map.getCanvas().style.cursor = '';
});
</script>
</body>
</html>
